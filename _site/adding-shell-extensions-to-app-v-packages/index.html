<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Adding Shell Extensions to App-V Packages | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Adding Shell Extensions to App-V Packages" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Inspired by a post on the ThinApp blog on Adding Shell Extensions to ThinApp Packages, I’ve documented here how to add Shell Extensions to an App-V package using the Windows Installer file generated by the App-V Sequencer." />
<meta property="og:description" content="Inspired by a post on the ThinApp blog on Adding Shell Extensions to ThinApp Packages, I’ve documented here how to add Shell Extensions to an App-V package using the Windows Installer file generated by the App-V Sequencer." />
<link rel="canonical" href="/adding-shell-extensions-to-app-v-packages/" />
<meta property="og:url" content="/adding-shell-extensions-to-app-v-packages/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-04-27T20:28:07+10:00" />
<script type="application/ld+json">
{"description":"Inspired by a post on the ThinApp blog on Adding Shell Extensions to ThinApp Packages, I’ve documented here how to add Shell Extensions to an App-V package using the Windows Installer file generated by the App-V Sequencer.","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"/adding-shell-extensions-to-app-v-packages/","headline":"Adding Shell Extensions to App-V Packages","dateModified":"2011-04-27T20:28:07+10:00","datePublished":"2011-04-27T20:28:07+10:00","mainEntityOfPage":{"@type":"WebPage","@id":"/adding-shell-extensions-to-app-v-packages/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="stealthpuppy" /></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Adding Shell Extensions to App-V Packages</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2011-04-27T20:28:07+10:00" itemprop="datePublished">Apr 27, 2011
      </time><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card"
          itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Inspired by a post on the ThinApp blog on <a href="http://blogs.vmware.com/thinapp/2011/04/adding-shell-extensions-to-thinapp-packages.html">Adding Shell Extensions to ThinApp Packages</a>, I’ve documented here how to add Shell Extensions to an App-V package using the Windows Installer file generated by the App-V Sequencer.</p>

<h2 id="caveats">Caveats</h2>

<p>There are several caveats to keep in mind:</p>

<ul>
  <li>By default, App-V only adds file type associations so that you can double click on a file to open it in a virtual package. This approach is not changing that behaviour</li>
  <li>This will only work for file or folder right-click menu options, it won’t get other shell integration working</li>
  <li>As we are editing the package Windows Installer file, your App-V deployment must use the MSI file to install the package. You could use an OSD script to integrate these changes, but the user would need to run the package at least once for the script to execute</li>
</ul>

<h2 id="right-click-items-for-winrar">Right-click Items for WinRAR</h2>

<p>In this example, I’m using <a href="http://www.rarlab.com/download.htm">WinRAR</a> (just like the ThinApp example), so I’ve had to determine the command line passed to WinRAR by each right-click item. To do that I’ve used <a href="http://technet.microsoft.com/en-us/sysinternals/bb896653">Process Explorer</a> with an installed version of WinRAR.</p>

<p>In this example, I will add the following right-click options:</p>

<ul>
  <li><em>Add to archive…</em> to folders</li>
  <li><em>Compress and email…</em> to folders</li>
  <li><em>Extract files…</em> to .RAR files</li>
</ul>

<p>Viewing the properties of the WINRAR.EXE process displays the command line used for each item:</p>

<p><img src="/media/2011/04/WinRAR-CommandLine.png" alt="WinRAR-CommandLine" /></p>

<h2 id="editing-the-msi">Editing the MSI</h2>

<p>To add these right-click items, I’m using my favourite MSI editor <a href="http://www.instedit.com/">InstEd</a> to open the MSI that the App-V Sequencer generated when I sequenced WinRAR. Making these edits was a manual process for me, but depending on which MSI editor you use there are probably simpler ways of achieving the same thing.</p>

<p>There are four tables in the MSI where I need to make changes:</p>

<ul>
  <li>Component</li>
  <li>Registry</li>
  <li>FeatureComponents</li>
  <li>InstallExecuteSequence</li>
</ul>

<h2 id="component-table">Component Table</h2>

<p>Go to the Component table and create a new entry. This will require a unique name (I’ve used <em>AppVShellValues</em>) and GUID - your MSI editor should be able to generate the GUID for you.</p>

<p><img src="/media/2011/04/Component-Table.png" alt="Component-Table" /></p>

<h2 id="registry-table">Registry Table</h2>

<p>The Registry table, which is empty by default, will require one entry per addition to the Registry. In this example I have three entries:</p>

<table>
  <thead>
    <tr>
      <th>Registry</th>
      <th>Root</th>
      <th>Key</th>
      <th>Name</th>
      <th>Value</th>
      <th>Component_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ShellValue001</td>
      <td>-1</td>
      <td>Software\Classes\Directory\shell\Add to archive…\Command</td>
      <td>null</td>
      <td>“[SGINSTALLPATH]\sfttray.exe” /launch “[ProductName]” a -ep1  -scul -r0 -iext – . “%1”</td>
      <td>AppVShellValues</td>
    </tr>
    <tr>
      <td>ShellValue002</td>
      <td>-1</td>
      <td>Software\Classes\Directory\shell\Compress and email…\Command</td>
      <td>null</td>
      <td>“[SGINSTALLPATH]\sfttray.exe” /launch “[ProductName]” a -ieml. -ep1  -scul -r0 -iext – . “%1”</td>
      <td>AppVShellValues</td>
    </tr>
    <tr>
      <td>ShellValue003</td>
      <td>-1</td>
      <td>Software\Classes\WinRAR\shell\Extract files…\Command</td>
      <td>null</td>
      <td>“[SGINSTALLPATH]\sfttray.exe” /launch “[ProductName]” x -iext -ow -ver – “%1” “?”</td>
      <td>AppVShellValues</td>
    </tr>
  </tbody>
</table>

<p>The entries will each need to use the following items:</p>

<ul>
  <li><em>Registry</em>: this requires a unique value</li>
  <li><em>Root</em>: the value corresponds to HKLM</li>
  <li><em>Key</em>: the key path will be dependent on the menu item; however each key will require the \Command path</li>
  <li><em>Name</em>: this is the Registry value being added, in this example we are editing the default value, so leave this as null</li>
  <li><em>Value</em>: the command that the item will run. This passes command line arguments to SFTTRAY which will launch the application and then pass the command line to WinRAR.</li>
  <li>_Component__: use the component name created in the previous step</li>
</ul>

<p>The command stored in the Value column must launch the application via the App-V Client and pass parameters to that application:</p>

<ul>
  <li>I can reference the App-V Client install folder as [SGINSTALLPATH] as this is a property in the MSI</li>
  <li>I need to use the application name as listed in the App-V shortcut. In my example I can use [ProductName] because the App-V package name and the application name are the same; however this may not be the case for all packages. The application name may need to be hard coded into the MSI here. You could create a new entry in the Property table for the application name and reference it here</li>
  <li>The rest of the command is what is passed to the application by SFTTRAY.EXE</li>
</ul>

<p><img src="/media/2011/04/Registry-Table.png" alt="Registry-Table" /></p>

<h2 id="featurecomponents-table">FeatureComponents Table</h2>

<p>Add a new entry to the FeatureComponents table - use <em>VirtualApp</em> in the Feature_ column and select the same component used in the previous tables in the Component_ column</p>

<p><img src="/media/2011/04/FeatureComponents-Table.png" alt="FeatureComponents-Table" /></p>

<h2 id="installexecutesequence-table">InstallExecuteSequence Table</h2>

<p>The last step is to ensure that the Registry entries added to the MSI are installed in the correct order. As the MSI file is really just a wrapper for the SFTMIME command, the Registry entries could be overwritten when the SFTMIME command adds the package.</p>

<p>To change the sequence find the <em>WriteRegistryValues</em> entry which will have a Sequence value of <em>5000</em>. Change this value to <em>6580</em> which will ensure that our custom Registry entries are added after the package is added and loaded but before the installer completes its finalize tasks.</p>

<p><img src="/media/2011/04/InstallExecuteSequence-Table.png" alt="InstallExecuteSequence-Table" /></p>

<h2 id="install-the-package">Install the Package</h2>

<p>If the modifications to the MSI have been completed correctly, you should see your right-click menu options from within Windows Explorer:</p>

<p><img src="/media/2011/04/RightClickMenu.png" alt="RightClickMenu" /></p>

  </div><a class="u-url" href="/adding-shell-extensions-to-app-v-packages/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
      <h2 class="footer-heading">stealthpuppy</h2>
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>on end user computing and enterprise mobility</p>
      </div>

      <div class="social-links"><ul class="social-media-list"><li><a href="https://github.com/aaronparker" title="aaronparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a href="https://www.linkedin.com/in/aaronedwardparker" title="aaronedwardparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a href="https://twitter.com/stealthpuppy" title="stealthpuppy"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li><li><a href="/feed.xml" title="atom"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg></a></li></ul>
</div>
    </div>

  </div>

</footer>
</body>

</html>
