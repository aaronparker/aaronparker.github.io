<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Sequencing Apple iTunes 10 | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Sequencing Apple iTunes 10" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Here’s a nut I’ve been trying to crack for some time – successfully virtualizing Apple iTunes with App-V. I think a combination of iTunes 10 and App-V 4.6 SP1 did the trick. Here’s how to do it." />
<meta property="og:description" content="Here’s a nut I’ve been trying to crack for some time – successfully virtualizing Apple iTunes with App-V. I think a combination of iTunes 10 and App-V 4.6 SP1 did the trick. Here’s how to do it." />
<link rel="canonical" href="/sequencing-apple-itunes-10/" />
<meta property="og:url" content="/sequencing-apple-itunes-10/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-06-15T22:33:23+10:00" />
<script type="application/ld+json">
{"description":"Here’s a nut I’ve been trying to crack for some time – successfully virtualizing Apple iTunes with App-V. I think a combination of iTunes 10 and App-V 4.6 SP1 did the trick. Here’s how to do it.","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"/sequencing-apple-itunes-10/","headline":"Sequencing Apple iTunes 10","dateModified":"2011-06-15T22:33:23+10:00","datePublished":"2011-06-15T22:33:23+10:00","mainEntityOfPage":{"@type":"WebPage","@id":"/sequencing-apple-itunes-10/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="stealthpuppy" /></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Sequencing Apple iTunes 10</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2011-06-15T22:33:23+10:00" itemprop="datePublished">Jun 15, 2011
      </time><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card"
          itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href=".com/virtualisation/sequencing-apple-itunes-10/attachment/itunes10/" rel="attachment wp-att-2279"><img class="alignright size-full wp-image-2279" style="margin-left: 5px; margin-right: 5px;" title="iTunes10" src=".com/media/2011/06/iTunes10.png" alt="iTunes 10 icon" width="128" height="128" /></a>Here’s a nut I’ve been trying to crack for some time – successfully virtualizing Apple iTunes with App-V. I think a combination of iTunes 10 and App-V 4.6 SP1 did the trick. Here’s how to do it.</p>

<h1 id="what-you-lose-by-virtualizing-itunes">What you lose by virtualizing iTunes</h1>

<p>Because virtualizing iTunes with App-V will isolate the application from the OS, the following features will not be available once iTunes has been sequenced:</p>

<ul>
  <li>The iTunes Jump List</li>
  <li>The iTunes toolbar integration into the Taskbar</li>
  <li>Windows Firewall exclusions (manual changes will be required to support media sharing)</li>
</ul>

<h1 id="itunes-components">iTunes Components</h1>

<p>To start at the beginning requires taking a look at the components of iTunes. Note that iTunes comes in 32-bit and 64-bit versions, so be sure to <a href="http://support.apple.com/downloads/">download</a> and sequence the correct version for your target platform. I tested this sequence using iTunes 10.3.1 x86 on 32-bit Windows; however the same approach will apply for the 64-bit version and future versions of 10.x.</p>

<p>Extracting <a href="http://www.apple.com/itunes/download/">the iTunes installer</a> results in several files:</p>

<ul>
  <li>AppleSoftwareUpdate.msi – Software Update is used to download and Apple software and updates</li>
  <li>SetupAdmin.exe – the setup wrapper application</li>
  <li>AppleApplicationSupport.msi – all Apple applications on Windows require this as a dependency</li>
  <li>AppleMobileDeviceSupport.msi – required for Apple mobile device support (iPhone, iPad etc.). This installer includes the drivers for Apple’s devices</li>
  <li>QuickTime.msi – iTunes uses QuickTime for video codec support</li>
  <li>Bonjour.msi - <a href="http://support.apple.com/kb/HT2250">iTunes uses Bonjour</a> to find shared music libraries, to find AirPort Express devices for streaming music to, and to find Apple TVs</li>
  <li>iTunes.msi – the iTunes installer itself</li>
</ul>

<p>It is important that <em>Apple Software Update</em> is not included in the App-V package – allowing the applications in the package to update will at best fail and at worst, most likely bloat the package if it were allowed to run after deployment. Before copying the iTunes setup files into your sequencing VM, delete <em>AppleSoftwareUpdate.msi</em> and <em>SetupAdmin.exe</em>. This will prevent the iTunes installer from automatically installing Software Update during sequencing.</p>

<h1 id="prepare-the-sequencing-vm">Prepare the Sequencing VM</h1>

<p>I have successfully created an iTunes package using a virtual machine running 32-bit Windows 7 SP1 with Internet Explorer 9 and all current updates.</p>

<p>I used a VFS install, so I have configured a second virtual hard disk to host the Q: drive to <a href="http://www.tmurgent.com/TmBlog/?p=402">avoid this bug</a>. If you would prefer a MNT install, just add the INSTALLDIR to the command line for each Windows Installer file.</p>

<p>Before starting the Sequencer, three steps must be completed:</p>

<ol>
  <li>Install <em>Apple Application Support</em> – this is required because the Apple Mobile Device service will not start without it.</li>
  <li>Install Apple Mobile Device Support – this is required to be installed outside of the package because it contains the mobile device drivers</li>
  <li>Create an iTunes folder structure in the user profile under %AppData%</li>
</ol>

<p>These same steps will need to be followed on the App-V client computer that will run iTunes. Fortunately Apple Application Support and the Mobile Device Support come as Windows Installer files, so they will be easy to deploy.</p>

<h1 id="what-to-do-about-appdata">What to do about AppData</h1>

<p>iTunes is a excellent example of an application written by developers who appear to have absolutely no idea about how Windows profiles work. Take a look at the size of the <em>AppData\Roaming\Apple Computer</em> folder in my profile on an existing computer with iTunes installed:</p>

<p><a href="/media/2011/06/09AppData.png">&lt;img style=”background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;” title=”09AppData” src=”.com/media/2011/06/09AppData_thumb.png” alt=”09AppData</a></p>

<p>With logs, a back-up of two devices and two copies of iOS 4.3.3 (one for an iPhone and one for an iPad), this folder is a whopping 8.41 GB and contains over 17000 files. Just imagine enabling Roaming Profiles with that in your profile – that’s a lot of coffee waiting for logon to complete.</p>

<p>To be fair, I don’t think that iTunes was intended to be used in an environment with Roaming Profiles; but the amount of data that iTunes stores in this location highlights one of the challenges we face when developers make questionable decisions.</p>

<p>There are two ways of getting around this problem:</p>

<ol>
  <li>Do not virtualize the user profile at all – iTunes will create the AppData folder structure in the user profile at launch just like it would for any new user account</li>
  <li>Virtualize only those portions of the user profile that contain iTunes preferences – you might like to take this approach if you want to preconfigure iTunes</li>
</ol>

<p>In this article I will demonstrate how to take approach number 2. If you would prefer approach 1, ensure that %CSIDL_APPDATA% has been added to the exclusions list before sequencing.</p>

<h1 id="before-sequencing--create-the-appdata-folders">Before Sequencing – Create the AppData folders</h1>

<p>To work around the large amount of data that iTunes stores in the profile, create the following folders before sequencing:</p>

<ul>
  <li>%AppData%\Apple Computer\iTunes\iPad Software Updates</li>
  <li>%AppData%\Apple Computer\iTunes\iPad Updater Logs</li>
  <li>%AppData%\Apple Computer\iTunes\iPhone Carrier Support</li>
  <li>%AppData%\Apple Computer\iTunes\iPhone Software Updates</li>
  <li>%AppData%\Apple Computer\iTunes\iPhone Updater Logs</li>
  <li>%AppData%\Apple Computer\iTunes\iPod Software Updates</li>
  <li>%AppData%\Apple Computer\iTunes\iPod Updater Logs</li>
  <li>%AppData%\Apple Computer\WebKit</li>
  <li>%AppData%\Apple Computer\iTunes\Apple Mobile Device Sync Diagnostics Logs</li>
  <li>%AppData%\Apple Computer\Logs</li>
  <li>%AppData%\Apple Computer\MobileSync</li>
  <li>%AppData%\Apple Computer\SyncServices\Local</li>
</ul>

<p>By creating these folder before sequencing will make it simpler to set Merge with Local attributes on the captured folders. The paths above will then also be excluded from the package and must be created on the App-V client computer at runtime.</p>

<h1 id="installing-itunes">Installing iTunes</h1>

<p><strong>[Update July 2012]</strong>: QuickTime is not longer included with the iTunes installer.  If you using a recent version of iTunes, disregard the QuickTime components of this article.</p>

<p>Sequencing is as simple as capturing the installation of the following files and configuring iTunes the way we want:</p>

<ul>
  <li>Bonjour.msi</li>
  <li>iTunes.msi</li>
  <li>QuickTime.msi</li>
</ul>

<p>However, iTunes and QuickTime store preferences in less than ideal locations. Here are the default locations for those preferences:</p>

<ul>
  <li>Most iTunes preferences are stored here: <em>%AppData%\Apple Computer\iTunes\iTunesPrefs.xml</em></li>
  <li>Some computer specific preferences are stored here: <em>%LocalAppData%\Apple Computer\iTunes\iTunesPrefs.xml</em></li>
  <li>QuickTime preferences are stored here: <em>%LocalAppData%Low\Apple Computer\QuickTime\QuickTime.qtp</em></li>
  <li>QuickTime Player preferences are stored here: <em>%LocalAppData%\Apple Computer\QuickTime\QTPlayerSession.xml</em></li>
</ul>

<p>Ideally these would all be located under %AppData%. Unfortunately the only preference file that we can move is for QuickTime (<em>%LocalAppData%Low\Apple Computer\QuickTime\QuickTime.qtp</em>).</p>

<p>To change the QuickTime preferences location, change the path under the following Registry value:</p>

<ul>
  <li>HKCU\Software\Apple Computer, Inc.\QuickTime\LocalUserPreferences\FolderPath</li>
</ul>

<p>I do not recommend attempting to include the %LocalAppData% or %LocalAppData%Low locations as these end up containing cache files which we need to avoid capturing to keep the package size to a minimum.</p>

<h1 id="automating-the-itunes-install">Automating the iTunes install</h1>

<p>There’s no reason why you couldn’t install and configure QuickTime and iTunes during sequencing manually; however I think that scripting the process as much as possible will help create a more successful package. I have a script that performs the following:</p>

<ul>
  <li>Installs QuickTime and iTunes with updates and desktop shortcuts disabled</li>
  <li>Installs Bonjour</li>
  <li>Perform some clean-up actions including removing unneeded shortcuts</li>
  <li>Changes the QuickTime configuration file location to %AppData% (instead of the AppData\LocalLow folder)</li>
  <li>Copy in a pre-configured QuickTime configuration file</li>
  <li>Create the folders in %AppData% that we want to capture in the package</li>
  <li>Start QuickTime Player and then iTunes to provide an opportunity to configure each application (first-run tasks)</li>
</ul>

<p>You can download the script here:</p>

<p class="download">
  [download id="41&#8243; format="1&#8243;]
</p>

<p>Place the script into the same folder as the iTunes Windows Installer files as it will attempt to run the MSI files from the same location.</p>

<h1 id="sequencer-exclusions">Sequencer Exclusions</h1>

<p>There are a number of locations that we need to exclude from capture during sequencing:</p>

<ul>
  <li>%CSIDL_APPDATA%\Apple Computer\iTunes\iPad Software Updates</li>
  <li>%CSIDL_APPDATA%\Apple Computer\iTunes\iPad Updater Logs</li>
  <li>%CSIDL_APPDATA%\Apple Computer\iTunes\iPhone Carrier Support</li>
  <li>%CSIDL_APPDATA%\Apple Computer\iTunes\iPhone Software Updates</li>
  <li>%CSIDL_APPDATA%\Apple Computer\iTunes\iPhone Updater Logs</li>
  <li>%CSIDL_APPDATA%\Apple Computer\iTunes\Apple Mobile Device Sync Diagnostics Logs</li>
  <li>%CSIDL_APPDATA%\Apple Computer\Logs</li>
  <li>%CSIDL_APPDATA%\Apple Computer\MobileSync</li>
  <li>%CSIDL_APPDATA%\Apple Computer\SyncServices</li>
  <li>\REGISTRY\USER\%SFT_SID%\Software\Microsoft\Windows\CurrentVersion\Internet Settings</li>
  <li>\REGISTRY\USER\%SFT_SID%_Classes\Local Settings\Software\Microsoft\Windows\Shell</li>
  <li>%CSIDL_PROFILE%\Music</li>
</ul>

<p>I have included these in a Package Template for iTunes that you can download from here:</p>

<p class="download">
  [download id="40&#8243; format="1&#8243;]
</p>

<h1 id="sequencing-itunes">Sequencing iTunes</h1>

<p>To sequence iTunes, follow the basic outline here:</p>

<ol>
  <li>
    <p>Start the Sequencer and create a new package from the iTunes template available above</p>
  </li>
  <li>
    <p>Create a Standard Application package</p>
  </li>
  <li>
    <p>Package installer – select either the iTunes scripted install command listed above or <em>C:\Windows\System32\cmd.exe</em></p>
  </li>
  <li>
    <p>Add a package name – I have used <em>Apple iTunes 10 x86</em></p>
  </li>
  <li>
    <p>Start the installation. You can run iTunes and QuickTime during this step to perform first run tasks.</p>
  </li>
  <li>
    <p>First Run tasks</p>
  </li>
</ol>

<ul>
  <li>QuickTime – follow the recommendations for configuration in this article: <a href="/virtualisation/sequencing-apple-quicktime-7x/">Virtualising Apple QuickTime 7.x</a></li>
  <li>iTunes – iTunes will prompt to make itself the default for media files – set this if required and be sure to disable the option ‘Warn me if iTunes is not the default player for audio files’</li>
</ul>

<ol>
  <li>Customize shortcuts</li>
</ol>

<ul>
  <li>Remove the <em>About Bonjour</em> &amp; <em>PictureViewer</em> shortcuts (I recommend removing all shortcuts, leaving only QuickTime and iTunes)</li>
  <li>Remove QuickTime shortcut unless required</li>
  <li>Place all shortcuts under <em>\Programs\iTunes</em> in the Start Menu</li>
</ul>

<ol>
  <li>Primary Feature block</li>
</ol>

<ul>
  <li>Run iTunes, you may have to force exit of child processes if required</li>
  <li>No need to run QuickTime Player unless required</li>
</ul>

<h1 id="post-sequencing">Post-Sequencing</h1>

<p>There are a few post-sequencing tasks to perform:</p>

<p><strong>AppData</strong>: Check that Merge with Local has been applied to folders captured in AppData correctly. The image below shows the <em>Apple Computer</em> and <em>Apple Computer\iTunes</em> folders have been set to Merge with Local. If the pre-sequence steps that create the AppData folder structure are followed (or you are excluding AppData), then no manual action should be required.</p>

<p><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="06AppDataMerge" src=".com/media/2011/06/06AppDataMerge.png" alt="06AppDataMerge" width="660" height="392" border="0" /></p>

<p>Add a script to the iTunes OSD file to create the AppData folder structure that should exist on the real file system:</p>

<p><a href="/media/2011/06/iTunesScriptBody.png">&lt;img style=”background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;” title=”iTunesScriptBody” src=”.com/media/2011/06/iTunesScriptBody_thumb.png” alt=”iTunesScriptBody</a></p>

<p>For an example of what to add to the OSD file, download the example here:</p>

<p class="download">
  [download id="42&#8243; format="1&#8243;]
</p>

<p><strong>iPod Service</strong>: Set the <em>iPod Service</em> to Automatic. This will ensure that the service is ready as soon as iTunes starts.</p>

<p><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="07iPodService" src=".com/media/2011/06/07iPodService.png" alt="07iPodService" width="660" height="392" border="0" /></p>

<p><strong>Child Processes</strong>: when iTunes launches, several processes with also be started – AppleMobileDeviceHelper.exe, distnoted.exe (both installed instead of in the iTunes package), iPodService.exe and mDNSResponder.exe (The iPod and Bonjour services respectively).</p>

<p><a href="/media/2011/06/10ProcExp.png">&lt;img style=”background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;” title=”10ProcExp” src=”.com/media/2011/06/10ProcExp_thumb.png” alt=”10ProcExp</a></p>

<p>On occasion these processes may remain running after iTunes has exited, if this is the case (and you may have already seen this behaviour when building the Primary Feature block) set TERMINATECHILDREN to True in the iTunes OSD.</p>

<p><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="iTunesTerminateChildren" src=".com/media/2011/06/iTunesTerminateChildren.png" alt="iTunesTerminateChildren" width="660" height="231" border="0" /></p>

<p><strong>Compression</strong>: The package should weigh in at around 290Mb, so depending on your deployment method you could compress it to save bandwidth.</p>

<h1 id="running-itunes">Running iTunes</h1>

<p>Deploying the iTunes package will require the deployment of Apple Application Support and Apple Mobile Device Support to the client computers first. Without Apple Application Support the following will be the result of launching iTunes:</p>

<p><a href="/media/2011/06/NoAppleAppSupport.png">&lt;img style=”background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;” title=”NoAppleAppSupport” src=”.com/media/2011/06/NoAppleAppSupport_thumb.png” alt=”NoAppleAppSupport</a></p>

<p>While I’ve been able to test iTunes successfully running on an App-V Client, there appears (at this stage at least) to be only one issue – when plugging in a mobile device, the following error is displayed, twice:</p>

<p><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="AppleMobileDeviceService" src=".com/media/2011/06/AppleMobileDeviceService.png" alt="This iPhone cannot be used because the Apple Mobile Device service is not started" width="421" height="162" border="0" /></p>

<p>Although iTunes reports this error and I can confirm that the service is started (it’s running natively, not within the package), once acknowledged device sync works anyway. I’ve tested with LOCALINTERACTIONALLOWED which hasn’t helped. I’ll update this post if I find a solution.</p>

<p>Last, but not least, for media sharing to work, firewall exceptions will be required for the following processes:</p>

<ul>
  <li>iTunes - Q:\Apple iTunes 10 x86\VFS\CSIDL_PROGRAM_FILES\iTunes\iTunes.exe</li>
  <li>Bonjour service - Q:\Apple iTunes 10 x86\VFS\CSIDL_PROGRAM_FILES\Bonjour\mDNSResponder.exe</li>
</ul>

<p>The path to the processes may change depending where you install iTunes and dependent components.</p>

  </div><a class="u-url" href="/sequencing-apple-itunes-10/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
      <h2 class="footer-heading">stealthpuppy</h2>
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>on end user computing and enterprise mobility</p>
      </div>

      <div class="social-links"><ul class="social-media-list"><li><a href="https://github.com/aaronparker" title="aaronparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a href="https://www.linkedin.com/in/aaronedwardparker" title="aaronedwardparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a href="https://twitter.com/stealthpuppy" title="stealthpuppy"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li><li><a href="/feed.xml" title="atom"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg></a></li></ul>
</div>
    </div>

  </div>

</footer>
</body>

</html>
