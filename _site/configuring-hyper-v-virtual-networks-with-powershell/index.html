<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Configuring Hyper-V Virtual Networks with PowerShell | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Configuring Hyper-V Virtual Networks with PowerShell" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve been configuring a Windows Server 2008 R2 Hyper-V deployment in the lab via MDT to a couple of ProLiant DL380 G5’s. I’ve been keeping the deployment as simple as possible, so there’s no SCVMM integrated at this point and as such I’ve need to configure the Hyper-V networking once the OS is deployed to the machine. Naturally, I don’t want to do that manually." />
<meta property="og:description" content="I’ve been configuring a Windows Server 2008 R2 Hyper-V deployment in the lab via MDT to a couple of ProLiant DL380 G5’s. I’ve been keeping the deployment as simple as possible, so there’s no SCVMM integrated at this point and as such I’ve need to configure the Hyper-V networking once the OS is deployed to the machine. Naturally, I don’t want to do that manually." />
<link rel="canonical" href="/configuring-hyper-v-virtual-networks-with-powershell/" />
<meta property="og:url" content="/configuring-hyper-v-virtual-networks-with-powershell/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-03-16T18:11:18+11:00" />
<script type="application/ld+json">
{"description":"I’ve been configuring a Windows Server 2008 R2 Hyper-V deployment in the lab via MDT to a couple of ProLiant DL380 G5’s. I’ve been keeping the deployment as simple as possible, so there’s no SCVMM integrated at this point and as such I’ve need to configure the Hyper-V networking once the OS is deployed to the machine. Naturally, I don’t want to do that manually.","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"/configuring-hyper-v-virtual-networks-with-powershell/","headline":"Configuring Hyper-V Virtual Networks with PowerShell","dateModified":"2012-03-16T18:11:18+11:00","datePublished":"2012-03-16T18:11:18+11:00","mainEntityOfPage":{"@type":"WebPage","@id":"/configuring-hyper-v-virtual-networks-with-powershell/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="stealthpuppy" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/smb-not-cifs.html">SMB not CIFS</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Configuring Hyper-V Virtual Networks with PowerShell</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2012-03-16T18:11:18+11:00" itemprop="datePublished">Mar 16, 2012
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I’ve been configuring a Windows Server 2008 R2 Hyper-V deployment in the lab via MDT to a couple of ProLiant DL380 G5’s. I’ve been keeping the deployment as simple as possible, so there’s no SCVMM integrated at this point and as such I’ve need to configure the Hyper-V networking once the OS is deployed to the machine. Naturally, I don’t want to do that manually.</p>

<p>I’ve taken the opportunity write something in PowerShell that can perform the configuration via the MDT task sequence. To do that I’ve had to resort to the <a href="http://pshyperv.codeplex.com/" title="PowerShell Management Library for Hyper-V">PowerShell Management Library for Hyper-V</a>. A special thanks to <a href="https://twitter.com/#!/JeffWouters">Jeff Wouters</a> for pointing me in the right direction with a couple of the Hyper-V specific commands.</p>

<p>An odd occurrence when deploying Windows Server to these boxes is that the adapter names often change between each deployment. So what might be <em>HP NC373i Multifunction Gigabit Server Adapter #13</em> today becomes <em>HP NC373i Multifunction Gigabit Server Adapter #14</em> when I next re-deploy Windows to that box.</p>

<p><img class="alignnone size-full wp-image-2676" title="Hyper-V Virtual Networks" src="https://stealthpuppy.com/wp-content/uploads/2012/03/HyperVVirtualNetworks.png" alt="Hyper-V Virtual Networks" width="660" height="324" srcset="https://stealthpuppy.com/wp-content/uploads/2012/03/HyperVVirtualNetworks.png 660w, https://stealthpuppy.com/wp-content/uploads/2012/03/HyperVVirtualNetworks-150x73.png 150w, https://stealthpuppy.com/wp-content/uploads/2012/03/HyperVVirtualNetworks-300x147.png 300w" sizes="(max-width: 660px) 100vw, 660px" /></p>

<p>Because the <em>New-VMExternalSwitch</em> and <em>Remove-VMSwitchNic</em> commandlets to used configure the virtual networks require the adapter description, I’ve had to come up with a way to grab the description based on some that remains static - the MAC address. List below is a script that contains a list of MAC addresses (you could improve on this by keeping the list in a file) for each target MAC address in each server.</p>

<p>It’s just a simple list, so if I add another server, I just add the new server’s MAC address to the list. The script returns the description of the adapter with that MAC address and then uses that to configure the new virtual network. Enjoy.</p>

<p>[code language=”ps”]## Configures a Hyper-V external virtual network based on a supplied MAC address</p>

<p>## Variables ##<br />
# Path to the PowerShell Management Library for Hyper-V<br />
$HyperVLibrary = “$env:ProgramFiles\modules\HyperV”</p>

<p># Virtual switch name<br />
$SwitchName = “External”</p>

<p># List of MAC addresses for the adapter in each server to be bound to a virtual switch<br />
# HV1=00:1C:C4:D8:36:BA; HV2=00:19:BB:C9:63:04;<br />
$MACAddressList = “00:1C:C4:D8:36:BA”, “00:19:BB:C9:63:04”</p>

<p># If the PowerShell Management Library for Hyper-V exists, we’re good to go<br />
If (Test-Path $HyperVLibrary) {</p>

<p># Match a MAC address to a local adapter and return the adapter description<br />
$Adapters = get-wmiobject -query “Select * From Win32_NetworkAdapterConfiguration”<br />
For ($n=0; $n -le $MACAddressList.Count -1; $n++) {<br />
For ($i=0; $i -le $Adapters.Count -1; $i++) {<br />
If ($MACAddressList[$n] -eq $Adapters[$i].MACAddress) {<br />
$AdapterDecription = $Adapters[$i].Description<br />
}<br />
}<br />
}</p>

<p># Configure Hyper-V networking with the supplied MAC Address<br />
If ($AdapterDecription) {</p>

<p># Import the PowerShell Management Library for Hyper-V<br />
Import-Module $HyperVLibrary</p>

<p># Create the Hyper-V network and remove the option ‘Allow management operating system to share this network adapter’<br />
New-VMExternalSwitch -VirtualSwitchName $SwitchName -ExternalEthernet $AdapterDecription -force<br />
Remove-VMSwitchNic -Name $SwitchName -Force<br />
}<br />
Else {<br />
Write-Warning “Unable to match a local adapter from the list of supplied MAC addresses.”<br />
}<br />
}<br />
Else {<br />
Write-Warning “‘$HyperVLibrary’ doesn’t exist. Unable to continue without the PowerShell Management Library for Hyper-V.”<br />
}<br />
[/code]</p>

  </div><a class="u-url" href="/configuring-hyper-v-virtual-networks-with-powershell/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">stealthpuppy</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/aaronparker"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">aaronparker</span></a></li><li><a href="https://www.twitter.com/stealthpuppy"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">stealthpuppy</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>on end user computing and enterprise mobility</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
