<p>I’ve previously posted about retrieving the <a href="http://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> from <a href="http://stealthpuppy.com/retrieving-a-vms-uuid-from-vsphere/">a virtual machine hosted on vSphere</a>. UUIDs are useful if you want to uniquely identify a target machine for OS deployment task sequences and the like (e.g. MDT). Here’s how to obtain the UUID from a virtual machine hosted on Hyper-V.</p>

<p>Just like with vSphere, the UUID isn’t a property of the virtual machine that can be queried directly. We need to go via WMI to query the target virtual machine. Note that in this function, I’m using <a href="http://blogs.msdn.com/b/virtual_pc_guy/archive/2012/05/30/the-v2-wmi-namespace-in-hyper-v-on-windows-8.aspx">version 2 of the Root\Virtualization WMI namespace</a> (root\virtualization\v2. This means the function as written, will <a href="http://msdn.microsoft.com/en-us/library/hh850319(v=vs.85)">only work on Windows 8 and Windows Server 2012</a> (and above). If you want to use this function on earlier versions of Hyper-V, remove the “\v2” from the namespace.</p>

<p>As an example, here’s how to retrieve the UUIDs from a set of VMs on a target Hyper-V host named <em>hv1</em>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; Get-HypervVMUUID -ComputerName hv1 -VM win71, file3, pvs1

Name		BIOSGUID
----		----
WIN71		E6E1A176-0713-4BB0-99E9-4570A1A3A94A 
FILE3		9E9D788A-15E2-4760-A049-9F6EB88677A9 
PVS1		74EFF5BC-A24E-48C3-85BE-12D758FE7AB6
</code></pre></div></div>

<p>Here’s the full function code listing. Please let me know if you find any bugs:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#---------------------------------------------------------------------------</span>
<span class="c1"># Author: Aaron Parker</span>
<span class="c1"># Desc:   Function that uses retrieves the UUID from a specified VM and</span>
<span class="c1">#         formats it into the right format for use with MDT/SCCM etc</span>
<span class="c1"># Date:   Aug 18, 2014</span>
<span class="c1"># Site:   http://stealthpuppy.com</span>
<span class="c1">#---------------------------------------------------------------------------</span>
<span class="k">Function </span>Get-HypervVMUUID <span class="o">{</span>
   <span class="cm">&lt;#
        .SYNOPSIS
            Retrieve the UUID from a virtual machine or set of virtual machines.
 
        .DESCRIPTION
            This function will retrieve the UUID from from a virtual machine or set of virtual machines from a Hyper-V host.
 
        .PARAMETER ComputerName
            Specifies the host from which to query the virtual machine or set of virtual machines.
 
        .PARAMETER VM
            Specifies the virtual machine or set of virtual machines (a comma delimited list) from which to obtain the UUID/s.
 
         .EXAMPLE
            PS C:\&amp;gt; Get-HypervVMUUID -ComputerName hv1 -VM win71, win72
 
            This command retrieves the UUIDs from the virtual machines win71 and win72 from the host hv1.
 
        .EXAMPLE
            PS C:\&amp;gt; Get-HypervVMUUID -VM win71, win72
 
            This command retrieves the UUIDs from the virtual machines win71 and win72 from the local host.
 
        .EXAMPLE
            PS C:\&amp;gt; Get-HypervVMUUID
 
            This command retrieves the UUIDs from the all of the virtual machines on the local host.
 
        .NOTES
            http://stealthpuppy.com/retrieving-a-vms-uuid-from-hyperv/ for support information.
 
        .LINK
            http://stealthpuppy.com/retrieving-a-vms-uuid-from-hyperv/
    #&gt;</span>
    <span class="o">[</span><span class="na">cmdletbinding</span><span class="o">(</span><span class="na">SupportsShouldProcess</span><span class="o">=</span><span class="nv">$True</span><span class="o">)]</span>
    <span class="k">param</span><span class="o">(</span>
        <span class="o">[</span>Parameter<span class="o">(</span><span class="nv">Mandatory</span><span class="o">=</span><span class="nv">$false</span>,HelpMessage<span class="o">=</span><span class="s2">"Specifies one or more Hyper-V hosts from which virtual machine UUIDs are to be retrieved. NetBIOS names, IP addresses, and fully-qualified domain names are allowable. The default is the local computer — use ""localhost"" or a dot (""."") to specify the local computer explicitly."</span><span class="o">)]</span>
        <span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="nv">$ComputerName</span>,

        <span class="o">[</span>Parameter<span class="o">(</span><span class="nv">Mandatory</span><span class="o">=</span><span class="nv">$false</span>, <span class="nv">Position</span><span class="o">=</span>0,HelpMessage<span class="o">=</span><span class="s2">"Specifies the virtual machine from which to retrieve the UUID."</span><span class="o">)]</span>
        <span class="o">[</span><span class="kt">string</span><span class="o">[]]</span><span class="nv">$VM</span>
    <span class="o">)</span>

    <span class="c1"># If ComputerName parameter is not specified, set value to the local host</span>
    <span class="k">If</span> <span class="o">(!</span><span class="nv">$ComputerName</span><span class="o">)</span> <span class="o">{</span> <span class="nv">$ComputerName</span> <span class="o">=</span> <span class="s2">"."</span> <span class="o">}</span>

    <span class="c1"># If VM parameter is specified, return those VMs, else return all VMs</span>
    <span class="k">If</span> <span class="o">(</span><span class="nv">$VM</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">$UUIDs</span> <span class="o">=</span> Get-VM -ComputerName <span class="nv">$ComputerName</span> -VM <span class="nv">$VM</span> -ErrorAction SilentlyContinue | <span class="nb">Select-Object </span>Name,@<span class="o">{</span><span class="nv">Name</span><span class="o">=</span><span class="s2">"BIOSGUID"</span>;<span class="nv">Expression</span><span class="o">={(</span><span class="nb">Get-WmiObject</span> -ComputerName <span class="nv">$_</span>.ComputerName -Namespace <span class="s2">"root\virtualization\v2"</span> -Class Msvm_VirtualSystemSettingData -Property BIOSGUID -Filter <span class="o">(</span><span class="s2">"InstanceID = 'Microsoft:{0}'"</span> -f <span class="nv">$_</span>.VMId.Guid<span class="o">))</span>.BIOSGUID<span class="o">}}</span>
    <span class="o">}</span> <span class="k">Else</span> <span class="o">{</span>
        <span class="nv">$UUIDs</span> <span class="o">=</span> Get-VM -ComputerName <span class="nv">$ComputerName</span> -ErrorAction SilentlyContinue | <span class="nb">Select-Object </span>Name,@<span class="o">{</span><span class="nv">Name</span><span class="o">=</span><span class="s2">"BIOSGUID"</span>;<span class="nv">Expression</span><span class="o">={(</span><span class="nb">Get-WmiObject</span> -ComputerName <span class="nv">$_</span>.ComputerName -Namespace <span class="s2">"root\virtualization\v2"</span> -Class Msvm_VirtualSystemSettingData -Property BIOSGUID -Filter <span class="o">(</span><span class="s2">"InstanceID = 'Microsoft:{0}'"</span> -f <span class="nv">$_</span>.VMId.Guid<span class="o">))</span>.BIOSGUID<span class="o">}}</span>
    <span class="o">}</span>

    <span class="c1"># Remove curly brackets from the UUIDs and return the array</span>
    <span class="k">ForEach</span> <span class="o">(</span> <span class="nv">$UID</span> <span class="k">in</span> <span class="nv">$UUIDs</span> <span class="o">)</span> <span class="o">{</span> <span class="nv">$UID</span>.BIOSGUID <span class="o">=</span> <span class="nv">$UID</span>.BIOSGUID -replace <span class="s2">"}"</span>; <span class="nv">$UID</span>.BIOSGUID <span class="o">=</span> <span class="nv">$UID</span>.BIOSGUID -replace <span class="s2">"{"</span> <span class="o">}</span>
    <span class="k">Return</span> <span class="nv">$UUIDs</span>
<span class="o">}</span>
</code></pre></div></div>
