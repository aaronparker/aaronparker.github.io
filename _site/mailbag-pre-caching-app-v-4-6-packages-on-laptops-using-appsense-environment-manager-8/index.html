<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Mailbag - Pre-caching App-V 4.6 packages on Laptops using AppSense Environment Manager 8 | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Mailbag - Pre-caching App-V 4.6 packages on Laptops using AppSense Environment Manager 8" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="on end user computing and enterprise mobility" />
<meta property="og:description" content="on end user computing and enterprise mobility" />
<link rel="canonical" href="http://localhost:4000/mailbag-pre-caching-app-v-4-6-packages-on-laptops-using-appsense-environment-manager-8/" />
<meta property="og:url" content="http://localhost:4000/mailbag-pre-caching-app-v-4-6-packages-on-laptops-using-appsense-environment-manager-8/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-07-26T22:46:47+10:00" />
<script type="application/ld+json">
{"description":"on end user computing and enterprise mobility","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"http://localhost:4000/mailbag-pre-caching-app-v-4-6-packages-on-laptops-using-appsense-environment-manager-8/","headline":"Mailbag - Pre-caching App-V 4.6 packages on Laptops using AppSense Environment Manager 8","dateModified":"2012-07-26T22:46:47+10:00","datePublished":"2012-07-26T22:46:47+10:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/mailbag-pre-caching-app-v-4-6-packages-on-laptops-using-appsense-environment-manager-8/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="stealthpuppy" /><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="apple-mobile-web-app-title" content="stealthpuppy">
  <meta name="application-name" content="stealthpuppy">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="theme-color" content="#ffffff">
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/smb-not-cifs.html">SMB not CIFS</a><a class="page-link" href="https://docs.stealthpuppy.com/docs">PROJECTS</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Mailbag - Pre-caching App-V 4.6 packages on Laptops using AppSense Environment Manager 8</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2012-07-26T22:46:47+10:00" itemprop="datePublished">Jul 26, 2012
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><img class="size-full wp-image-2631 alignnone" title="Mail Bag" src="/media/2012/02/Mail-Bag.png" alt="Mail Bag" width="128" height="128" /></p>

<p><a href="https://twitter.com/Rorymon">Rory</a> <a href="https://twitter.com/Rorymon/status/228536440403931136">asks via Twitter</a> - can we pre-cache App-V packages on laptop clients so that all applications are available offline, using <a href="http://www.appsense.com/policy-and-governance">AppSense Environment Manager</a>?:</p>

<p style="text-align: center;">
  <img class="size-full wp-image-2796 aligncenter" title="Rory Asks" src="/media/2012/07/RoryAsks.png" alt="Rory Asks" width="519" height="138" srcset="/media/2012/07/RoryAsks.png 519w, /media/2012/07/RoryAsks-150x39.png 150w, /media/2012/07/RoryAsks-300x79.png 300w" sizes="(max-width: 519px) 100vw, 519px" />
</p>

<p style="text-align: left;">
  As with many solutions in Environment Manager, there's probably a number of ways to achieve this - here's just one.
</p>

<h1 id="the-logic">The Logic</h1>

<p style="text-align: left;">
  In Rory's scenario, he's using the App-V Management Server to deliver packages. This means that packages are delivered to users only and not to the client (i.e. globally). First up we'll need to work out what we're trying to achieve here:
</p>

<ul>
  <li>Is the client a laptop?</li>
  <li>How do we determine whether the laptop can contact the streaming source?</li>
  <li>How to cache all of the packages to the client?</li>
  <li>We’ll most likely also need to ensure that the pre-caching doesn’t run too often or doesn’t run over a VPN connection</li>
</ul>

<p>Determining whether the local machine is a laptop is quite simple, but we’ll need to resort to some custom code to that. Fortunately we don’t need to re-invent the wheel - we can use this code by <a href="http://www.robvanderwoude.com/">Rob van der Woude</a> that <a href="http://www.robvanderwoude.com/vbstech_inventory_laptop.php">uses WMI to look for a battery</a>:</p>

<p>[code language=”vb”]If IsLaptop( “.” ) Then<br />
‘ WScript.Echo “Laptop”<br />
‘ Return Success<br />
WScript.Quit 0<br />
Else<br />
‘ WScript.Echo “Desktop or server”<br />
‘ Return failure<br />
WScript.Quit 1<br />
End If</p>

<p>Function IsLaptop(myComputer)<br />
‘ This Function checks if a computer has a battery pack.<br />
‘ Argument: myComputer [string] name of the computer to check, or “.” for the local computer<br />
‘ Written by Rob van der Woude<br />
‘ http://www.robvanderwoude.com<br />
On Error Resume Next<br />
Set objWMIService = GetObject( “winmgmts://” &amp; myComputer &amp; “/root/cimv2” )<br />
Set colItems = objWMIService.ExecQuery( “Select * from Win32_Battery”, , 48 )<br />
IsLaptop = False<br />
For Each objItem in colItems<br />
IsLaptop = True<br />
Next<br />
If Err Then Err.Clear<br />
On Error Goto 0<br />
End Function[/code]</p>

<p>Add this to a <strong>Reusable Condition</strong> (or even an inline condition if you’d like) that includes this code as a Custom Condition. Make sure to set the Custom Condition <strong>Type</strong> to VBscript and enable ‘Evaluate Once Per Session’ and ‘Run As System User’.</p>

<p>Next up, you may want determine whether the client can contact the streaming source (what ever that is - App-V Management Server, App-V Streaming Server, HTTP or even a UNC path).  You could use native <strong>Computer IP Address</strong> condition and make the assumption that the remote host is available because the client is located in a known network, or <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2012/02/24/use-powershell-to-test-connectivity-on-remote-servers.aspx">ping the remote host using PowerShell</a> in a <strong>Custom Condition</strong>. Alternatively an Active Directory Site Membership might suffice, however this may require listing all of your AD sites which isn’t ideal.</p>

<p>For a Computer IP Address condition, choose Condition / Computer / Computer IP Address and configure the required IP range. Ensure that ‘Evaluate Once Per Session’ is <strong>disabled</strong> - because the client IP address may change during a single session. Repeat this for multiple IP ranges.</p>

<p>To use a PowerShell script instead, create a Custom Condition, set the <strong>Type</strong> to PowerShell, <em>disable</em> ‘Evaluate Once Per Session’ and set ‘Run As System User’.</p>

<p>[code language=”ps”]$servers = “appv1.domain.local”<br />
If (!(Test-Connection -Cn $server -BufferSize 16 -Count 1 -ea 0 -quiet))<br />
{<br />
exit 0<br />
Else<br />
exit 1<br />
}[/code]</p>

<p>Now that we know the client is a laptop and we know that it can contact the streaming source, we can run the command to cache the applications. You’ll need an Execute Action to run this command:</p>

<p>[code]”%ProgramFiles%\Microsoft Application Virtualization Client\SFTTRAY.exe” /HIDE /LOADALL[/code]</p>

<p>This will load all packages and ensure that the progress bar is not shown.</p>

<p align="center">
  <a href="/media/2012/07/Run-SFTTRAY.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="Run-SFTTRAY" src="/media/2012/07/Run-SFTTRAY_thumb.png" alt="Run-SFTTRAY" width="660" height="500" border="0" /></a>
</p>

<p>If you are publishing packages to users, configure this action to run in the current user’s context. If you are delivering packages globally and using a streaming source, configure this action to run in the System context.</p>

<h1 id="implementing">Implementing</h1>

<p>To put this into action, we’ll need to think about when to run the SFTTRAY command. User Logon might be an obvious choice, but this could potentially slow down the logon process; however we do need run the action not long after logon because we can’t run it before the user disconnects the machine or logs off (running the action at logoff, would delay logoff). There are a number of ways we can run the SFTTRAY action:</p>

<ul>
  <li>At User Process Started for <em>%ProgramFiles%\Microsoft Application Virtualization Client\sftdcc.exe</em> launches - this will run at logon, but the logon process should be mostly complete by this time</li>
  <li>At Network Connected - we have an opportunity to cache packages when connecting back to the corporate network if the laptop is resuming from sleep mode</li>
  <li>Session Locked - this is a great time to cache packages because the user is not interacting with the desktop</li>
</ul>

<p>I’ve included a sample configuration below that uses each of these approaches by applying the logic in a Reusable Node linked to each of the triggers listed above.</p>

<p><a href="/media/2012/07/Pre-cacheConfig.png">&lt;img style=”background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;” title=”Pre-cacheConfig” src=”/media/2012/07/Pre-cacheConfig_thumb.png” alt=”Pre-cacheConfig</a></p>

<p>Download the configuration shown above from here:</p>

<p class="important">
  [download id="57&#8243; format="1&#8243;]
</p>

  </div><a class="u-url" href="/mailbag-pre-caching-app-v-4-6-packages-on-laptops-using-appsense-environment-manager-8/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
      <h2 class="footer-heading">stealthpuppy</h2>
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>on end user computing and enterprise mobility</p>
      </div>

      <div class="social-links"><ul class="social-media-list"><li><a href="https://github.com/aaronparker" title="aaronparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a href="https://www.linkedin.com/in/aaronedwardparker" title="aaronedwardparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a href="https://twitter.com/stealthpuppy" title="stealthpuppy"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li><li><a href="/feed.xml" title="atom"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg></a></li></ul>
</div>
    </div>

  </div>

</footer>
</body>

</html>
