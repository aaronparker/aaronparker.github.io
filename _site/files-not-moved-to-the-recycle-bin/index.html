<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Files Not Moved to the Recycle Bin? | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Files Not Moved to the Recycle Bin?" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="On our internal Terminal Servers the CEO has been having an issue whereby files or folders are not sent to the Recycle Bin, rather they are immediately deleted. If you logon with administrative rights on the machine, you can send files to the Recycle Bin. To date, he’d been told that this would be fixed once we move to some new boxes (which I did last week). Unfortunately the problem also exists on the new Terminal Servers which I only found out after the CEO pointed the problem out to me (luckily he’s a pretty understanding guy)." />
<meta property="og:description" content="On our internal Terminal Servers the CEO has been having an issue whereby files or folders are not sent to the Recycle Bin, rather they are immediately deleted. If you logon with administrative rights on the machine, you can send files to the Recycle Bin. To date, he’d been told that this would be fixed once we move to some new boxes (which I did last week). Unfortunately the problem also exists on the new Terminal Servers which I only found out after the CEO pointed the problem out to me (luckily he’s a pretty understanding guy)." />
<link rel="canonical" href="/files-not-moved-to-the-recycle-bin/" />
<meta property="og:url" content="/files-not-moved-to-the-recycle-bin/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2007-04-23T06:51:00+10:00" />
<script type="application/ld+json">
{"description":"On our internal Terminal Servers the CEO has been having an issue whereby files or folders are not sent to the Recycle Bin, rather they are immediately deleted. If you logon with administrative rights on the machine, you can send files to the Recycle Bin. To date, he’d been told that this would be fixed once we move to some new boxes (which I did last week). Unfortunately the problem also exists on the new Terminal Servers which I only found out after the CEO pointed the problem out to me (luckily he’s a pretty understanding guy).","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"/files-not-moved-to-the-recycle-bin/","headline":"Files Not Moved to the Recycle Bin?","dateModified":"2007-04-23T06:51:00+10:00","datePublished":"2007-04-23T06:51:00+10:00","mainEntityOfPage":{"@type":"WebPage","@id":"/files-not-moved-to-the-recycle-bin/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="stealthpuppy" /></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Files Not Moved to the Recycle Bin?</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2007-04-23T06:51:00+10:00" itemprop="datePublished">Apr 23, 2007
      </time><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card"
          itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>On our internal Terminal Servers the CEO has been having an issue whereby files or folders are not sent to the Recycle Bin, rather they are immediately deleted. If you logon with administrative rights on the machine, you can send files to the Recycle Bin. To date, he’d been told that this would be fixed once we move to some new boxes (which I did last week). Unfortunately the problem also exists on the new Terminal Servers which I only found out after the CEO pointed the problem out to me (luckily he’s a pretty understanding guy).</p>

<p>So where do you start troubleshooting a problem like this? Well this is where my crusade for scripting everything has come in handy. Because I can go back through the unattended build for the Terminal Servers I can see exactly what happens during the build process and I came across a file system rights issue.</p>

<p>If you’ve ever administered Terminal Servers (or desktops for that matter) you will have seen that on occasion the root of the system partition can collect user files. How users can do this I don’t know, but they able to write to this location because the default permissions allow CREATOR OWNER write access. When I build Terminal Servers I like to restrict these permissions and run a command during the build to give users read-only access:</p>

<p>[code]CACLS %SystemDrive%\ /E /R “CREATOR OWNER” Users /P Everyone:R[/code]</p>

<p>This helps to keep the file system clean but does have side effects such as applications failing to write (why are they writing there in the first place?) or users can’t send object to the recycle bin (I’ve learnt my lesson now).</p>

<p>It turns out that the Recycle Bin folder (C:\RECYCLER on Windows XP/2003) is not created until the first user sends an object to the Recycle Bin. Of course on a system where I’ve restricted user access to the System partition, this will fail. If you run Process Monitor you’ll see an ACCESS DENIED result when the user attempts to delete an object. So how do we fix this? In my script I’ve added a command that creates the RECYCLER folder before the permissions are modified, thus giving users the rights to create their own Recycle Bin folder within C:\RECYCLER:</p>

<p>[code]MD %SystemDrive%\RECYCLER<br />
ATTRIB %SystemDrive%\RECYCLER +S +H<br />
CACLS %SystemDrive%\ /E /R “CREATOR OWNER” Users /P Everyone:R[/code]</p>

<p>On an existing system I needed to recreate the default permissions. This is not a simple as breaking out CACLS though; first I needed to find the SDDL (<a href="http://msdn2.microsoft.com/en-us/library/aa379567.aspx">Security Descriptor Definition Language</a>) <a href="http://www.washington.edu/computing/support/windows/UWdomains/SDDL.html">syntax</a> for the permissions, which I did with <a href="http://setacl.sourceforge.net/">SETACL</a>. Then I can run the following commands to restore the defaults to the RECYCLER folder:</p>

<p>[code]C:\CACLS %SYSTEMDRIVE%\RECYCLER /E /R EVERYONE<br />
C:\CACLS %SYSTEMDRIVE%\RECYCLER /S:”O:BAG:DUD:(A;OICI;FA;;;BA)(A;OICI;FA;;;SY)(A;;FA;;;BA)(A;OICIIO;GA;;;CO)(A;OICI;0x1200a9;;;BU)(A;CI;LC;;;BU)(A;CI;DC;;;BU)”[/code]</p>

  </div><a class="u-url" href="/files-not-moved-to-the-recycle-bin/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
      <h2 class="footer-heading">stealthpuppy</h2>
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>on end user computing and enterprise mobility</p>
      </div>

      <div class="social-links"><ul class="social-media-list"><li><a href="https://github.com/aaronparker" title="aaronparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a href="https://www.linkedin.com/in/aaronedwardparker" title="aaronedwardparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a href="https://twitter.com/stealthpuppy" title="stealthpuppy"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li><li><a href="/feed.xml" title="atom"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg></a></li></ul>
</div>
    </div>

  </div>

</footer>
</body>

</html>
