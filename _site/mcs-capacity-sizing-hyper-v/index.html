<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Machine Creation Services Capacity Sizing on Hyper-V | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Machine Creation Services Capacity Sizing on Hyper-V" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="[toc]" />
<meta property="og:description" content="[toc]" />
<link rel="canonical" href="/mcs-capacity-sizing-hyper-v/" />
<meta property="og:url" content="/mcs-capacity-sizing-hyper-v/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:image" content="/wp-content/uploads/2016/10/363468958_68baf091f1_o.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-10-24T12:57:54+11:00" />
<script type="application/ld+json">
{"description":"[toc]","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"/mcs-capacity-sizing-hyper-v/","image":"/wp-content/uploads/2016/10/363468958_68baf091f1_o.jpg","headline":"Machine Creation Services Capacity Sizing on Hyper-V","dateModified":"2016-10-24T12:57:54+11:00","datePublished":"2016-10-24T12:57:54+11:00","mainEntityOfPage":{"@type":"WebPage","@id":"/mcs-capacity-sizing-hyper-v/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="stealthpuppy" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">About</a><a class="page-link" href="/smb-not-cifs.html">SMB not CIFS</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Machine Creation Services Capacity Sizing on Hyper-V</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-10-24T12:57:54+11:00" itemprop="datePublished">Oct 24, 2016
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>[toc]</p>

<p>To <a href="http://stealthpuppy.com/machine-creation-services-storage-capacity/">understand sizing Machine Creation Services</a> on Hyper-V, we should first look at how XenDesktop creates virtual machines across the various deployment choices. XenDesktop 7.9 and 7.11 have introduced new features to MCS that will require additional consideration for storage requirements over previous versions.</p>

<p>In this article, I’ll cover the deployment options at a high level, including:</p>

<ul>
  <li><strong>Delta Clones</strong> – this has been the traditional deployment approach for MCS, where virtual machines reference a base image and store changes in a delta disk. In Hyper-V parlance, this is referred to as a differencing disk. Delta clones work for XenApp, pooled and dedicated clone VMs</li>
  <li><strong>Delta Clones with Storage Optimisation</strong> – this is the new default option for MCS deployments since XenDesktop 7.9. IO optimisation enables a cache in RAM with overflow to disk</li>
  <li><strong>Full Clones</strong> – new in XenDesktop 7.11 is the ability to deploy full clones from a master image and rely on the storage platform to provide optimisation</li>
</ul>

<p>To keep this size exercise simple, I have used a single data store that contains both my master image and the Machine Catalogs. The environment is based on Windows Server 2016 and System Center Virtual Machine Manager 2016. Note that Hyper-V allows for modifying the paths for virtual machines (config files), virtual hard disks and Smart Paging files, so the folder structure shown in my environment in the screenshots below may differ to yours.</p>

<h1 id="master-image">Master Image</h1>

<p>The master image is Windows Server 2012 R2 or 2016 with a set of applications including Office. Initially, the image has two snapshots (or checkpoints) created in the process of provisioning and updating the image. Thus the image consists of:</p>

<ul>
  <li><strong>Virtual disk of 13.63GB</strong> – this is the image as I’ve built it including Windows, applications, and the XenDesktop 7.9 VDA. This is using a thin-provisioned (or dynamic) disk with the default size of 127GB</li>
  <li><strong>Snapshot 1 of 4MB</strong> – the initial snapshot taken before creating the Machine Catalog. 4MB is the default size for new snapshots on Hyper-V</li>
  <li><strong>Snapshot 2 of 8.63GB</strong> – an update that included installing the 7.11 VDA. This sizeable given the changes in this snapshot include only a months’ worth of Windows updates (at around 90Mb) and an upgrade from the VDA 7.9 to 7.11.</li>
</ul>

<figure id="attachment_5186" aria-describedby="caption-attachment-5186" style="width: 1024px" class="wp-caption alignnone">[<img class="wp-image-5186 size-large" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Disks-1024x482.png" alt="MCS Master Image on Hyper-V with 2 snapshots" width="1024" height="482" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Disks-1024x482.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Disks-150x71.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Disks-300x141.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Disks-768x361.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Disks.png 1061w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Disks.png)<figcaption id="caption-attachment-5186" class="wp-caption-text">MCS Master Image on Hyper-V with 2 snapshots</figcaption></figure>

<p>Note the time stamps of the snapshots here – when creating a snapshot via Virtual Machine Manager the previous snapshot is touched and the update in time stamp on the new 4MB snapshot.</p>

<p>Each virtual machine has a corresponding configuration file and runtime state file, although these won’t have a noticeable effect on overall storage capacity consumed.</p>

<figure id="attachment_5187" aria-describedby="caption-attachment-5187" style="width: 1024px" class="wp-caption alignnone">[<img class="wp-image-5187 size-large" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-VMs-1024x482.png" alt="Virtual Machines folder for the MCS Master Image on Hyper-V" width="1024" height="482" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-VMs-1024x482.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-VMs-150x71.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-VMs-300x141.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-VMs-768x361.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-VMs.png 1061w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-VMs.png)<figcaption id="caption-attachment-5187" class="wp-caption-text">Virtual Machines folder for the MCS Master Image on Hyper-V</figcaption></figure>

<p>Additional versions of these files are created per snapshot so that changes to the VM hardware are tracked.</p>

<figure id="attachment_5188" aria-describedby="caption-attachment-5188" style="width: 1024px" class="wp-caption alignnone">[<img class="wp-image-5188 size-large" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Snapshots-1024x482.png" alt="Snapshots folder for the MCS Master Image on Hyper-V" width="1024" height="482" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Snapshots-1024x482.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Snapshots-150x71.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Snapshots-300x141.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Snapshots-768x361.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Snapshots.png 1061w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-HyperV-TopLevel-Datastore-MasterImage-Snapshots.png)<figcaption id="caption-attachment-5188" class="wp-caption-text">Snapshots folder for the MCS Master Image on Hyper-V</figcaption></figure>

<h2 id="how-large-is-the-master-image">How Large is the Master Image?</h2>

<p>Not all master images will be the same size due to environmental differences; however, count on a minimum of 14GB for Windows + Office for all current Windows versions. I recommend <a href="http://stealthpuppy.com/cleaning-up-and-reducing-the-size-of-your-master-image/">cleaning up your master image</a> to reduce the size as much as is possible.</p>

<p>With each update to the master image, you’ll see snapshots growing. Looking at my test environment after making 3 updates to the image my master image has grown considerably with what should be relatively small changes (i.e. booting the VM to install applications or updates).</p>

<figure id="attachment_5193" aria-describedby="caption-attachment-5193" style="width: 1024px" class="wp-caption alignnone">[<img class="wp-image-5193 size-large" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Master-Image-3-Snapshots-1024x467.png" alt="Master Image and snapshots after 3 updates" width="1024" height="467" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Master-Image-3-Snapshots-1024x467.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Master-Image-3-Snapshots-150x68.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Master-Image-3-Snapshots-300x137.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Master-Image-3-Snapshots-768x350.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Master-Image-3-Snapshots.png 1093w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Master-Image-3-Snapshots.png)<figcaption id="caption-attachment-5193" class="wp-caption-text">Master Image and snapshots after 3 updates</figcaption></figure>

<p>What started at 14GB has now grown to a total of 31GB with installing VDA updates, the FSLogix agent, Java runtimes and Windows Updates.</p>

<h1 id="mcs-machine-catalogs">MCS Machine Catalogs</h1>

<p>The configuration choices made during the creation of a Machine Catalog can impact the way in which virtual machines are configured and the capacity consumed. The following choices will result in slightly different inputs for our sizing:</p>

<ol>
  <li>Server OS vs. Desktop OS</li>
  <li>Delta clones with <a href="https://www.citrix.com/blogs/2016/08/03/introducing-mcs-storage-optimisation/">Storage Optimisation</a> (cache in RAM with overflow to disk)</li>
  <li>Full Clones</li>
  <li>AppDisks (not compatible with the storage optimisation feature)</li>
  <li>Personal vDisk (not compatible with XenApp deployments)</li>
</ol>

<h2 id="temporary-cache-sizes-with-default-configurations">Temporary Cache Sizes with Default Configurations</h2>

<p>The default configuration for XenApp VMs, pooled random and pooled static desktops, since 7.9, is to enable the cache in RAM with a corresponding temporary disk cache as shown in the screenshot below. For both Server and Desktop OS machines, the default RAM cache size is 256Mb; however, the disk cache size default is different:</p>

<ul>
  <li>For Server OS VMs, the default size will match the size of the virtual disk assigned to the master image</li>
  <li>With Desktop OS VMs, the default size is <strong>10GB</strong>.</li>
</ul>

<p>You will need to make careful consideration for the amount of RAM assigned to the RAM cache. This cache size is consumed from the RAM assigned to the VM, so the more RAM that you can assign, the larger the RAM cache you can set. With a larger RAM cache, the amount of IO written out to storage will be less, thus capacity consumed will be reduced.</p>

<figure id="attachment_5200" aria-describedby="caption-attachment-5200" style="width: 806px" class="wp-caption alignnone">[<img class="wp-image-5200 size-full" src="http://stealthpuppy.com/wp-content/uploads/2016/10/01_CreatingMachineCatalog-Default.png" alt="Default virtual machine options for XenApp Machine Catalogs" width="806" height="605" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/01_CreatingMachineCatalog-Default.png 806w, https://stealthpuppy.com/wp-content/uploads/2016/10/01_CreatingMachineCatalog-Default-150x113.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/01_CreatingMachineCatalog-Default-300x225.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/01_CreatingMachineCatalog-Default-768x576.png 768w" sizes="(max-width: 806px) 100vw, 806px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/01_CreatingMachineCatalog-Default.png)<figcaption id="caption-attachment-5200" class="wp-caption-text">Default virtual machine options for XenApp Machine Catalogs</figcaption></figure>

<p>You can choose to place temporary storage disks on separate data stores to your virtual machines – for example, you could choose shared storage for the virtual machines and local storage (ideally flash-based) for the temporary storage disks.</p>

<p>If you reduce the disk cache size from the default, Studio will warn that reducing the size may impact performance. For Server OS VMs (XenApp), where multiple users on a single machine, a larger disk cache is required.</p>

<figure id="attachment_5233" aria-describedby="caption-attachment-5233" style="width: 806px" class="wp-caption alignnone">[<img class="size-full wp-image-5233" src="http://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-RDS.png" alt="Disk cache size warning for Server OS VMs" width="806" height="605" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-RDS.png 806w, https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-RDS-150x113.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-RDS-300x225.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-RDS-768x576.png 768w" sizes="(max-width: 806px) 100vw, 806px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-RDS.png)<figcaption id="caption-attachment-5233" class="wp-caption-text">Disk cache size warning for Server OS VMs</figcaption></figure>

<p>Reducing the disk cache size for Desktop OS VMs from the default 10GB, results in the same message, which is potentially confusing.</p>

<figure id="attachment_5234" aria-describedby="caption-attachment-5234" style="width: 806px" class="wp-caption alignnone">[<img class="size-full wp-image-5234" src="http://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-VDI.png" alt="Disk cache size warning for Desktop OS VMs" width="806" height="605" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-VDI.png 806w, https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-VDI-150x113.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-VDI-300x225.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-VDI-768x576.png 768w" sizes="(max-width: 806px) 100vw, 806px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/Virtual-Machine-Options-VDI.png)<figcaption id="caption-attachment-5234" class="wp-caption-text">Disk cache size warning for Desktop OS VMs</figcaption></figure>

<h2 id="appdisks">AppDisks</h2>

<p><a href="https://docs.citrix.com/en-us/xenapp-and-xendesktop/7-11/install-configure/appdisks.html">AppDisks</a> are applicable to specific Machine Catalog configurations and the sizes will vary based on the applications and number of applications in each image. However, AppDisks can potentially assist with reducing the <a href="https://docs.citrix.com/en-us/xenapp-and-xendesktop/7-11/install-configure/appdisks.html#par_anchortitle_405a">storage capacity</a> consumed, especially if they are shared across multiple catalogues. AppDisks do need to be stored on the same data store as the target MCS virtual machines.</p>

<h2 id="personal-vdisks">Personal vDisks</h2>

<p>Citrix provides some good information on <a href="https://docs.citrix.com/en-us/xenapp-and-xendesktop/7-11/install-configure/personal-vdisk/personal-vdisk-configure-manage.html">sizing for Personal vDisks</a> and these will have a pre-defined size. Additionally, Personal vDisks can be stored in a data store separate to the virtual machines (e.g on highly available shared storage). If that is the case, we can remove those from our sizing.</p>

<h2 id="base-disk">Base Disk</h2>

<p>MCS requires a copy of the master image on each target data store. During the creation of the Machine Catalog, the selected master image is copied to the data store and a temporary “preparation VM” is created to <a href="https://www.citrix.com/blogs/2016/04/04/machine-creation-service-image-preparation-overview-and-fault-finding/">prepare the catalogue for deploying VMs based on the master image</a>.</p>

<figure id="attachment_5196" aria-describedby="caption-attachment-5196" style="width: 1024px" class="wp-caption alignnone">[<img class="wp-image-5196 size-large" src="http://stealthpuppy.com/wp-content/uploads/2016/10/04_Preparing-Catalog-1024x450.png" alt="Machine Creation Services preparing the catalog via a temporary VM" width="1024" height="450" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/04_Preparing-Catalog-1024x450.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/04_Preparing-Catalog-150x66.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/04_Preparing-Catalog-300x132.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/04_Preparing-Catalog-768x337.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/04_Preparing-Catalog.png 1125w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/04_Preparing-Catalog.png)<figcaption id="caption-attachment-5196" class="wp-caption-text">Machine Creation Services preparing the catalogue via a temporary VM</figcaption></figure>

<p>This VM is deleted after use, so we don’t need to include it in our capacity calculations. Once the Machine Catalog is created we have the base image, which is an exact copy of our initial master image.</p>

<figure id="attachment_5197" aria-describedby="caption-attachment-5197" style="width: 1024px" class="wp-caption alignnone">[<img class="size-large wp-image-5197" src="http://stealthpuppy.com/wp-content/uploads/2016/10/03_Base-Disk-1024x450.png" alt="MCS machine catalog base image after initial deployment" width="1024" height="450" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/03_Base-Disk-1024x450.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/03_Base-Disk-150x66.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/03_Base-Disk-300x132.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/03_Base-Disk-768x337.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/03_Base-Disk.png 1125w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/03_Base-Disk.png)<figcaption id="caption-attachment-5197" class="wp-caption-text">MCS Machine Catalog base image after initial deployment</figcaption></figure>

<p>After a number of updates to the master image and applying them to the catalogue. The base image can contain <strong>3</strong> copies of the master image – the size of these copies will differ depending on the additional data written to the image after each update. Also, note the sizes of these in relation to the master image and snapshots above.</p>

<figure id="attachment_5198" aria-describedby="caption-attachment-5198" style="width: 1024px" class="wp-caption alignnone">[<img class="size-large wp-image-5198" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-1024x476.png" alt="MCS machine catalog base image after 3 updates" width="1024" height="476" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-1024x476.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-150x70.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-300x139.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-768x357.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates.png 1164w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates.png)<figcaption id="caption-attachment-5198" class="wp-caption-text">MCS Machine Catalog base image after 3 updates</figcaption></figure>

<p>However, this state is transient. Eventually, the number of copies of the master image maintained on the data store should be <strong>2</strong> – the current and previous versions of the image to enable rollback of the catalogue.</p>

<figure id="attachment_5199" aria-describedby="caption-attachment-5199" style="width: 1024px" class="wp-caption alignnone">[<img class="size-large wp-image-5199" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-2-images-1024x453.png" alt="MCS machine catalog base image after updates applied" width="1024" height="453" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-2-images-1024x453.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-2-images-150x66.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-2-images-300x133.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-2-images-768x340.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-2-images.png 1110w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-base-disk-updates-2-images.png)<figcaption id="caption-attachment-5199" class="wp-caption-text">MCS Machine Catalog base image after updates applied</figcaption></figure>

<p>We should still be accounting for the 3 image copies in our sizing to ensure updates to catalogues are possible after the initial deployment.</p>

<h2 id="virtual-machines">Virtual Machines</h2>

<p>What does a deployed virtual machine look like? In this case, I have a XenApp virtual machine on Windows Server 2012 R2 deployed with cache in RAM enabled. Immediately after deployment and before first boot, the VM looks like this:</p>

<figure id="attachment_5204" aria-describedby="caption-attachment-5204" style="width: 1024px" class="wp-caption alignnone">[<img class="size-large wp-image-5204" src="http://stealthpuppy.com/wp-content/uploads/2016/10/07_MCS-VM-Created-default-no-boot-1024x450.png" alt="Deployed MCS XenApp virtual machine with cache in RAM enabled that has not yet booted" width="1024" height="450" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/07_MCS-VM-Created-default-no-boot-1024x450.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/07_MCS-VM-Created-default-no-boot-150x66.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/07_MCS-VM-Created-default-no-boot-300x132.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/07_MCS-VM-Created-default-no-boot-768x337.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/07_MCS-VM-Created-default-no-boot.png 1125w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/07_MCS-VM-Created-default-no-boot.png)<figcaption id="caption-attachment-5204" class="wp-caption-text">Deployed MCS XenApp virtual machine with cache in RAM enabled that has not yet booted</figcaption></figure>

<p>Other than the VM configuration files, the VM consists of the following virtual disks:</p>

<ol>
  <li>The identity disk that contains the unique identity for the machine</li>
  <li>The TemporaryStorage disk used as the overflow target for the cache in RAM feature</li>
  <li>The differencing (or delta) disk that contains the differences from the master image when the machine is running</li>
</ol>

<p>After booting the VM and logging on with a single user session we see the following:</p>

<ol>
  <li>The identity disk size remains static and it does so for the life of the machine</li>
  <li>The TemporaryStorage disk sizes increases and does not change between reboots or updates</li>
  <li>The differencing (or delta) disk is reset back to the initial 4MB at each reboot and grows to a maximum size of 36MB.</li>
</ol>

<figure id="attachment_5205" aria-describedby="caption-attachment-5205" style="width: 1024px" class="wp-caption alignnone">[<img class="size-large wp-image-5205" src="http://stealthpuppy.com/wp-content/uploads/2016/10/12_MCS-VM-User-logon-Tempstorage-growing-1024x450.png" alt="MCS VM with temporary storage growth" width="1024" height="450" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/12_MCS-VM-User-logon-Tempstorage-growing-1024x450.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/12_MCS-VM-User-logon-Tempstorage-growing-150x66.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/12_MCS-VM-User-logon-Tempstorage-growing-300x132.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/12_MCS-VM-User-logon-Tempstorage-growing-768x337.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/12_MCS-VM-User-logon-Tempstorage-growing.png 1125w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/12_MCS-VM-User-logon-Tempstorage-growing.png)<figcaption id="caption-attachment-5205" class="wp-caption-text">MCS VM with temporary storage growth</figcaption></figure>

<p>Viewing the virtual machine storage details in Virtual Machine Manager, we see details of the virtual disks assigned to the virtual machines deployed via MCS and the master images. I have two master images on this data store:</p>

<ul>
  <li><strong>W2K12-master</strong> has no snapshots at this time, so a single Dynamic disk is shown with the default size of <strong>127GB</strong></li>
  <li><strong>W2K16-master</strong> has 1 snapshot, so the Differencing disk is shown, again with the default size of <strong>127GB</strong></li>
</ul>

<p>The MCS virtual machines each have the 3 virtual disks assigned:</p>

<ul>
  <li>The identity disk is a dynamic disk, yet a maximum size of 0.02GB (approximately 20MB)</li>
  <li>The Temporary Storage disk size is set during creation of the Machine Catalog – in this example, we can see the maximum size of this disk is <strong>64GB</strong>. Citrix recommends matching the size of this disk to the size of the virtual disk assigned to the master image</li>
  <li>The differencing disk maximum size is <strong>127GB</strong>, which is the default size of virtual disks in Hyper-V, matching the virtual disk size of the master image.</li>
</ul>

<figure id="attachment_5216" aria-describedby="caption-attachment-5216" style="width: 1024px" class="wp-caption alignnone">[<img class="size-large wp-image-5216" src="http://stealthpuppy.com/wp-content/uploads/2016/10/SCVMM-StorageView-All-1024x552.png" alt="MCS VM storage viewed in Virtual Machine Manager" width="1024" height="552" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/SCVMM-StorageView-All-1024x552.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/SCVMM-StorageView-All-150x81.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/SCVMM-StorageView-All-300x162.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/SCVMM-StorageView-All-768x414.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/SCVMM-StorageView-All.png 1234w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/SCVMM-StorageView-All.png)<figcaption id="caption-attachment-5216" class="wp-caption-text">MCS VM storage viewed in Virtual Machine Manager</figcaption></figure>

<p>This specific configuration is unique this deployment type, so if we look at different MCS configurations, we will see different outcomes for virtual disk configurations and sizes.</p>

<h2 id="clones-with-differencing-disks">Clones with Differencing Disks</h2>

<p>XenDesktop and XenApp 7.8 and below, used differencing (or delta) disks that contained the changes to the virtual machine from the original base disk. When deploying a virtual machine on these versions or without storage optimisation, a VM then consists of an identity disk and a differencing disk (which as shown previously, starts at 4MB).</p>

<figure id="attachment_5223" aria-describedby="caption-attachment-5223" style="width: 1018px" class="wp-caption alignnone">[<img class="size-full wp-image-5223" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-creation.png" alt="MCS Virtual Machines without storage optimisation (as per XenApp/XenDesktop 7.8 and below)" width="1018" height="494" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-creation.png 1018w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-creation-150x73.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-creation-300x146.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-creation-768x373.png 768w" sizes="(max-width: 1018px) 100vw, 1018px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-creation.png)<figcaption id="caption-attachment-5223" class="wp-caption-text">MCS Virtual Machines without storage optimisation (as per XenApp/XenDesktop 7.8 and below)</figcaption></figure>

<p>After booting the virtual machine, all changes are written to the differencing disk and you can see the growth in storage capacity consumed. In this example, I’ve booted a non-optimised Windows Server 2016 image and even without user sessions on that VM, the differencing disk size increases pretty readily.</p>

<figure id="attachment_5224" aria-describedby="caption-attachment-5224" style="width: 1018px" class="wp-caption alignnone">[<img class="size-full wp-image-5224" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-boot.png" alt="MCS Delta Clones after boot showing growth in the differencing disk" width="1018" height="494" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-boot.png 1018w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-boot-150x73.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-boot-300x146.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-boot-768x373.png 768w" sizes="(max-width: 1018px) 100vw, 1018px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-delta-disk-boot.png)<figcaption id="caption-attachment-5224" class="wp-caption-text">MCS Delta Clones after boot showing growth in the differencing disk</figcaption></figure>

<p>When the virtual machine restarts, the differencing disk is deleted and a new disk, again starting at 4MB, is created. So cycling VM regularly is a good way to keep storage consumed to a minimum.</p>

<h2 id="full-clones">Full Clones</h2>

<p>Deployment of <a href="https://www.citrix.com/blogs/2016/10/12/xenapp-and-xendesktop-7-11-mcs-full-clone-support/">full clones via MCS is now possible in XenDesktop 7.11</a>. Full clones consist of an identity disk and a copy of the base image for each virtual machine.</p>

<figure id="attachment_5226" aria-describedby="caption-attachment-5226" style="width: 1024px" class="wp-caption alignnone">[<img class="size-large wp-image-5226" src="http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Full-Clone-1024x472.png" alt="Disk configuration for MCS Full Clones" width="1024" height="472" srcset="https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Full-Clone-1024x472.png 1024w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Full-Clone-150x69.png 150w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Full-Clone-300x138.png 300w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Full-Clone-768x354.png 768w, https://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Full-Clone.png 1081w" sizes="(max-width: 1024px) 100vw, 1024px" />](http://stealthpuppy.com/wp-content/uploads/2016/10/MCS-Full-Clone.png)<figcaption id="caption-attachment-5226" class="wp-caption-text">Disk configuration for MCS Full Clones</figcaption></figure>

<p>Once a full clone is deployed, it is persistent while managed and updated through mechanisms outside of XenDesktop. The potential capacity that a full clone can consume will be the full size of the virtual disk as assigned to the master image.</p>

<h1 id="virtual-machine-sizing-on-hyper-v">Virtual Machine Sizing on Hyper-V</h1>

<p>To correctly size for Machine Creation Services on Hyper-V, let’s summarise the storage impact that MCS has with Hyper-V deployments:</p>

<h2 id="common-files">Common Files</h2>

<p>Virtual machine components that are common to all deployment types:</p>

<ul>
  <li><strong>Virtual machine configuration files</strong> – each virtual machine has virtual machine configuration and runtime state files (including versions for snapshots) that are typically very small and should not have an impact on overall sizing</li>
  <li><strong>Smart Paging files</strong> – Smart Paging only kicks in during machine boot when the host is under memory pressure. [I actually haven’t been able to get my host to generate these as yet]</li>
  <li><strong>Master images</strong> – count on a minimum of <strong>12GB</strong> for Windows 7/Windows Server 2008 R2 and above with Office. Create a maximum virtual disk size to fit your requirements – it would be best to reduce the size from the default of <strong>127GB</strong> to only what is required. Master images can exist on datastores that are accessible by all hosts, rather than the same datastore as the virtual machines</li>
  <li><strong>Master image snapshots</strong> – changes in the master image can count for several GB even with small changes to the image. Several snapshots can exist as changes are made to the master image and the amount of change of size between snapshots can vary as well</li>
  <li><strong>Base images</strong> – master image snapshots are merged, so the base image shows the real size of the master image. Up to <strong>3 copies of the</strong> <strong>base image</strong> can exist in a single datastore and the sizes will vary based on the actual changes to the master image. That 3rd copy is transient and should be removed after all machines have applied the latest update</li>
  <li><strong>Identity disks</strong> – on Hyper-V, these start at <strong>36MB</strong> and remain at this size</li>
</ul>

<h2 id="delta-clones-and-full-clones">Delta Clones and Full Clones</h2>

<p>Files used by delta clones and full clones include:</p>

<ul>
  <li><strong>Temporary storage disk</strong> – the new storage optimisation feature of MCS is the default configuration for 7.9 and above so this disk is used instead of the differencing disk. The temporary storage disk can grow to the size specified when creating the Machine Catalog. By default, that is the maximum size of the virtual disk assigned to the master image and Citrix recommends ensuring these sizes match. These disks start at <strong>4MB</strong> and persist for the life of the VM.</li>
  <li><strong>Differencing (or Delta) disk</strong> – if the storage optimisation feature <em>is not used</em>, the differencing disk is used instead. This can grow to the maximum size of the virtual disk of the master image. These disks start at <strong>4MB</strong> and jump to <strong>36MB</strong> at boot (regardless of whether storage optimisation is used or not) and can grow considerably. These are deleted at reboot (not shutdown) of the VM</li>
  <li><strong>Base image</strong> – if using full clones, each VM consists of an identity disk and a copy of the base image</li>
</ul>

<h2 id="other-files">Other Files</h2>

<p>Other files used in virtual machine deployment include:</p>

<ul>
  <li><strong>Personal vDisks</strong> – the default size is <strong>10GB</strong> and is shared between the user profile and user installed apps, but can be placed on separate storage</li>
  <li><strong>AppDisks</strong> – the size will vary based on specific applications sizes installed in the disk. AppDisks need to be on the same datastore as the virtual machines.</li>
</ul>

<h1 id="recommendations">Recommendations</h1>

<p>Sizing storage capacity for Machine Creation Services isn’t something that you’ll do in isolation or perhaps even do once – design, testing, piloting and monitoring in production will be key to a successful deployment. Here are a few recommendations for sizing storage capacity:</p>

<ul>
  <li>Size the virtual disk assigned to the master image to be as small as possible; however, don’t undersize the disk. Differencing disks and temporary cache disks sizes will match the size of the master image virtual disk, therefore they can grow to that maximum size</li>
  <li>Monitor the cache in RAM size to understand when overflow to disk kicks in. Resize the cache in RAM if it is undersized and you have available RAM to assign to VMs</li>
  <li>Boot virtual machines and watch the sizes of temporary cache disks and differencing disks to understand disk growth</li>
  <li>AppDisks or 3rd party layering solutions can enable you to reduce MCS storage capacity by sharing application images across VM instances</li>
</ul>

<h1 id="calculating-capacity">Calculating Capacity</h1>

<p>Based on the information in this article, to size capacity with Machine Creation Services on Hyper-V, the calculation will require answering a number of questions or inputs. At a high level this involves:</p>

<ul>
  <li>Is the master image on the same data store? If so:
    <ul>
      <li>The size of the master image</li>
      <li>The number and size of the snapshots applied to that master image</li>
    </ul>
  </li>
  <li>For each Machine Catalog on the data store:
    <ul>
      <li>Account for a minimum of 2 copies of the base image and up to 3 copies</li>
      <li>Base images may differ in size</li>
      <li>The number of virtual machines deployed in the catalog</li>
      <li>Each virtual machine will have an identity disk of 36MB</li>
      <li>Each virtual machine will have a differencing (or delta disk) that while powered on will be at least 36MB and reset at reboot to 4MB</li>
      <li>If the virtual machine is deployed with storage optimisation:
        <ul>
          <li>It will have a temporary storage disk that is not transient and will grow to several GB to a maximum size as specified when creating the Catalog</li>
        </ul>
      </li>
      <li>If the virtual machine is deployed without storage optimisation:
        <ul>
          <li>The differencing disk that is transient and can grow to several GB and will be reset at reboot</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Calculating storage capacity with this approach should provide you with a reasonably accurate picture of the total capacity to be consumed by MCS on that data store, before storage optimisation solutions such as deduplication and compression.</p>

<h1 id="conclusion">Conclusion</h1>

<p>While MCS itself is simple to design for and implement, recent flexibility and performance improvements introduced with XenDesktop 7.9 and 7.11, requires some additional considerations for storage capacity.</p>

<p>This article has walked through the MCS deployment options on Hyper-V and shown you the various capacity consumption scenarios so that we can go through a sizing exercise. In a future article, I’ll provide to tool to simplify calculating storage capacity.</p>

<p>Thanks to <a href="https://twitter.com/CarlWebster">Carl Webster</a> for reviewing this article. Feedback and corrections are welcome.</p>

  </div><a class="u-url" href="/mcs-capacity-sizing-hyper-v/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">stealthpuppy</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/aaronparker"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">aaronparker</span></a></li><li><a href="https://www.twitter.com/stealthpuppy"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">stealthpuppy</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>on end user computing and enterprise mobility
</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
