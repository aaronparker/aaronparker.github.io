<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Sequencing the App-V Management Console | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Sequencing the App-V Management Console" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Sequencing the the App-V Management Console is reasonably straight-forward; however it wasn’t quite as simple as you would expect." />
<meta property="og:description" content="Sequencing the the App-V Management Console is reasonably straight-forward; however it wasn’t quite as simple as you would expect." />
<link rel="canonical" href="http://localhost:4000/sequencing-the-app-v-management-console/" />
<meta property="og:url" content="http://localhost:4000/sequencing-the-app-v-management-console/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-01-21T18:30:40+11:00" />
<script type="application/ld+json">
{"description":"Sequencing the the App-V Management Console is reasonably straight-forward; however it wasn’t quite as simple as you would expect.","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"http://localhost:4000/sequencing-the-app-v-management-console/","headline":"Sequencing the App-V Management Console","dateModified":"2011-01-21T18:30:40+11:00","datePublished":"2011-01-21T18:30:40+11:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/sequencing-the-app-v-management-console/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="stealthpuppy" /><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="apple-mobile-web-app-title" content="stealthpuppy">
  <meta name="application-name" content="stealthpuppy">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="theme-color" content="#ffffff">
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/smb-not-cifs.html">SMB not CIFS</a><a class="page-link" href="https://docs.stealthpuppy.com/docs">PROJECTS</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Sequencing the App-V Management Console</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2011-01-21T18:30:40+11:00" itemprop="datePublished">Jan 21, 2011
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a rel="attachment wp-att-2110" href="/virtualisation/sequencing-the-app-v-management-console/attachment/appvconsolebox/"><img class="alignright size-full wp-image-2110" title="AppVConsoleBox" src="/media/2011/01/AppVConsoleBox.png" alt="" width="131" height="128" /></a>Sequencing the the App-V Management Console is reasonably straight-forward; however it wasn’t quite as simple as you would expect.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>The Application Virtualization Management Console requires the Microsoft Management Console (MMC) 3.0 or later and the .NET Framework 2.0 SP2. MMC 3.0 comes with all of the current Windows releases and the .NET Framework comes with Windows Vista and above, so you should only need to install the .NET Framework if you are targeting Windows XP or Windows Server 2003. MMC is an operating system component, so you won’t be able to sequence it.</p>

<h3 id="preparing-the-sequencer">Preparing the Sequencer</h3>

<p>I have used the 4.6 Sequencer and Windows 7 x86 for this sequence, so the prerequisites are already installed; however I have run the MMC at least once to ensure any Registry and AppData locations have been written prior to sequencing.</p>

<p><strong>Important</strong>: Stick with the x86 version of Windows because when sequencing on 64-bit Windows the snap-in does not appear to register during sequencing and this error is received when starting SftMMC.msc:</p>

<p><a rel="attachment wp-att-2083" href="/virtualisation/sequencing-the-app-v-management-console/attachment/unabletocreatenewdocument2/"><img class="size-full wp-image-2083" title="UnableToCreateNewDocument2" src="/media/2011/01/UnableToCreateNewDocument2.png" alt="Unable to create new document." width="291" height="171" srcset="/media/2011/01/UnableToCreateNewDocument2.png 291w, /media/2011/01/UnableToCreateNewDocument2-150x88.png 150w" sizes="(max-width: 291px) 100vw, 291px" /></a></p>

<p>I have successfully sequenced on 32-bit Windows 7 and run the package on 64-bit Windows.</p>

<h3 id="exclusion-items">Exclusion Items</h3>

<p>I found that I need to add <em>Q:\System Volume Information</em> to the list of exclusion items, as this was captured during monitoring.</p>

<h3 id="configuring-the-console-install">Configuring the Console Install</h3>

<p>I am using the setup source for the Management Server (not the Streaming Server) and I have chosen to install only the Management Console (we don’t want to capture the Management Server or web service). I am installing into a folder on the Q: drive; however this isn’t a requirement – you can install to the default Program Files location if you like.</p>

<p><a rel="attachment wp-att-2084" href="/virtualisation/sequencing-the-app-v-management-console/attachment/appvmanagementconsoleinstaller/"><img class="size-full wp-image-2084" title="AppVManagementConsoleInstaller" src="/media/2011/01/AppVManagementConsoleInstaller.png" alt="App-V Management Console install" width="504" height="382" srcset="/media/2011/01/AppVManagementConsoleInstaller.png 504w, /media/2011/01/AppVManagementConsoleInstaller-150x113.png 150w, /media/2011/01/AppVManagementConsoleInstaller-300x227.png 300w" sizes="(max-width: 504px) 100vw, 504px" /></a></p>

<p>Setup requests a reboot when finished, but the Sequencer will handle the reboot automatically.</p>

<p>To ensure that my sequence can be replicated quickly and easily, I have used the following command line to perform a silent installation of the console during the monitoring phase:</p>

<p>MSIEXEC /I setup.msi ADDLOCAL=Release_SoftGrid_Management_Console INSTALLDIR=Q:\APPVMMC.001\Console REBOOT=SUPPRESS OPTIN=FALSE /QB-</p>

<p>The complete list of command line options for the Console installer can be found in this knowledgebase article: <a href="http://support.microsoft.com/kb/2384955">Supported command line options for the Microsoft App-V 4.5 Management Server installer</a>.</p>

<h3 id="sequencing-the-console">Sequencing the Console</h3>

<p>Follow the recommendations outlined in the <a href="http://download.microsoft.com/download/F/7/8/F784A197-73BE-48FF-83DA-4102C05A6D44/App-46_Sequencing_Guide_Final.docx">Microsoft Application Virtualization 4.6 Sequencing Guide</a>.</p>

<p>Monitoring phase – install the Console during the Sequencing phase. Open MMC and check that the App Virt Management Console snap-in is available or start the Application Virtualization Management Console shortcut. There is no need to connect to a Management Server during sequencing.</p>

<p>Configure Applications phase – the default shortcut will point directly to the SftMMC.MSC file. In my case this was <em>“Q:\APPVMMC.001\Console\App Virt Management Console\SftMMC.msc”</em>. Change the Application Path to read <em>“C:\Windows\System32\MMC.EXE” “Q:\APPVMMC.001\Console\App Virt Management Console\SftMMC.msc”</em> instead (change the install path to suit your own environment). Change the Version and OSD File Name default text to suit your standards.</p>

<p>Once the package is saved, the CODEBASE line in the OSD file will include FILENAME and PARAMETERS elements that will look something like this:</p>

<p>[code]PARAMETERS=”"%SFT_MNT%\appvmmc.001\Console\App Virt Management Console\SftMMC.msc"” FILENAME=”%CSIDL_SYSTEM%\MMC.EXE”[/code]</p>

<p>Launch Applications phase – you can build Feature Block 1 if you require it, but the final package size is very small.</p>

<h3 id="saving-the-package">Saving the Package</h3>

<p>There are no additional changes that need to be made to the package. I saved my package with the following properties:</p>

<ul>
  <li>Operating Systems Selected: none</li>
  <li>Enforce Security Descriptors: enabled</li>
  <li>Generate Microsoft Windows Installer Package: enabled</li>
  <li>Compress Package: enabled</li>
</ul>

<h3 id="running-the-package">Running the Package</h3>

<p>The default requested execution level for the Microsoft Management Console is <a href="http://technet.microsoft.com/en-us/library/cc709628(WS.10).aspx">RunAsHighest</a>. This means that if you are running MMC as an account that is in the local Administrators group, UAC will prompt for elevation. This is a problem when running under App-V because the App-V client components do not request a higher token.</p>

<p>When you start the virtualised Management Console the following error will be produced:</p>

<p><a rel="attachment wp-att-2085" href="/virtualisation/sequencing-the-app-v-management-console/attachment/apprequireselevation/"><img class="size-full wp-image-2085" title="AppRequiresElevation" src="/media/2011/01/AppRequiresElevation.png" alt="The requested operation requires elevation. Error code: 4604EE8-1B401F2C-000002E4" width="501" height="276" srcset="/media/2011/01/AppRequiresElevation.png 501w, /media/2011/01/AppRequiresElevation-150x82.png 150w, /media/2011/01/AppRequiresElevation-300x165.png 300w" sizes="(max-width: 501px) 100vw, 501px" /></a></p>

<p>You can get around this issue three ways:</p>

<ol>
  <li>Run as a standard user only (the console allows you to connect to a remote system with alternate credentials)</li>
  <li>Right-clicking the shortcut and choosing <em>Run as administrator;</em> or</li>
  <li>Force the package to run with the user’s current execution level using the <a href="http://blogs.technet.com/b/virtualworld/archive/2010/04/13/the-requested-operation-requires-elevation-2c-000002e4.aspx">__COMPAT_LAYER environment variable</a>.</li>
</ol>

<p>Option 3 is probably the simplest method. To prevent MMC from requesting higher privileges, add the following lines to the OSD file inside the VIRTUALENV tag:</p>

<p>[code]<ENVLIST></ENVLIST></p>

<ENVIRONMENT VARIABLE="_\_COMPAT\_LAYER">RunAsInvoker</ENVIRONMENT>

<p>&lt;/ENVLIST&gt;[/code]</p>

<p>However this works great for 32-bit Windows only, using this method on a 64-bit platform results in these errors:</p>

<p><a rel="attachment wp-att-2086" href="/virtualisation/sequencing-the-app-v-management-console/attachment/64bit32bitmmc2/"><img class="size-full wp-image-2086" title="64Bit32BitMMC2" src="/media/2011/01/64Bit32BitMMC2.png" alt="An error occurred while starting the 64-bit MMC process. The 32-bit MMC process will run instead." width="480" height="171" srcset="/media/2011/01/64Bit32BitMMC2.png 480w, /media/2011/01/64Bit32BitMMC2-150x53.png 150w, /media/2011/01/64Bit32BitMMC2-300x106.png 300w" sizes="(max-width: 480px) 100vw, 480px" /></a></p>

<p>Then:</p>

<p><a rel="attachment wp-att-2083" href="/virtualisation/sequencing-the-app-v-management-console/attachment/unabletocreatenewdocument2/"><img class="size-full wp-image-2083" title="UnableToCreateNewDocument2" src="/media/2011/01/UnableToCreateNewDocument2.png" alt="Unable to create new document." width="291" height="171" srcset="/media/2011/01/UnableToCreateNewDocument2.png 291w, /media/2011/01/UnableToCreateNewDocument2-150x88.png 150w" sizes="(max-width: 291px) 100vw, 291px" /></a></p>

<p>I haven’t found a root cause, but the issue looks to be related to the App-V client. When using the <a href="http://blogs.msdn.com/b/cjacks/archive/2009/09/13/how-to-run-applications-manifested-as-highestavailable-with-a-logon-script-without-elevation-for-members-of-the-administrators-group.aspx">RunAsInvoker</a> trick outside of the client, MMC works as expected.</p>

<p>If you are deploying the package to 64-bit Windows, the <em>Run as administrator</em> option will be required to launch the console.</p>

<h3 id="resources">Resources</h3>

<ul>
  <li><a href="http://support.microsoft.com/kb/2559075/">Elevation and Run-As Considerations in Microsoft App-V Environments</a></li>
</ul>

  </div><a class="u-url" href="/sequencing-the-app-v-management-console/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
      <h2 class="footer-heading">stealthpuppy</h2>
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>on end user computing and enterprise mobility</p>
      </div>

      <div class="social-links"><ul class="social-media-list"><li><a href="https://github.com/aaronparker" title="aaronparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a href="https://www.linkedin.com/in/aaronedwardparker" title="aaronedwardparker"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a href="https://twitter.com/stealthpuppy" title="stealthpuppy"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li><li><a href="/feed.xml" title="atom"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg></a></li></ul>
</div>
    </div>

  </div>

</footer>
</body>

</html>
