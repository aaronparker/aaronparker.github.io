<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Group Policy Scripts can fail due to UAC | stealthpuppy</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Group Policy Scripts can fail due to UAC" />
<meta name="author" content="Aaron Parker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If you are starting to deploy Windows Vista you may have noticed that any user who has administrative access to their workstation will not receive mapped drives or printers. This is due to the new privilege model introduced in Windows Vista with User Account Control." />
<meta property="og:description" content="If you are starting to deploy Windows Vista you may have noticed that any user who has administrative access to their workstation will not receive mapped drives or printers. This is due to the new privilege model introduced in Windows Vista with User Account Control." />
<link rel="canonical" href="/group-policy-scripts-can-fail-due-to-uac/" />
<meta property="og:url" content="/group-policy-scripts-can-fail-due-to-uac/" />
<meta property="og:site_name" content="stealthpuppy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2007-04-02T22:57:00+10:00" />
<script type="application/ld+json">
{"description":"If you are starting to deploy Windows Vista you may have noticed that any user who has administrative access to their workstation will not receive mapped drives or printers. This is due to the new privilege model introduced in Windows Vista with User Account Control.","author":{"@type":"Person","name":"Aaron Parker"},"@type":"BlogPosting","url":"/group-policy-scripts-can-fail-due-to-uac/","headline":"Group Policy Scripts can fail due to UAC","dateModified":"2007-04-02T22:57:00+10:00","datePublished":"2007-04-02T22:57:00+10:00","mainEntityOfPage":{"@type":"WebPage","@id":"/group-policy-scripts-can-fail-due-to-uac/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="stealthpuppy" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">stealthpuppy</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">About</a><a class="page-link" href="/appv-faqs.html">App-V 4.x FAQs</a><a class="page-link" href="/appv5-faqs.html">Microsoft Application Virtualization 5 FAQs</a><a class="page-link" href="/appvrecipes.html">App-V Recipes</a><a class="page-link" href="/home-page.html">Home Page</a><a class="page-link" href="/scriptcorner.html">Script Corner</a><a class="page-link" href="/smb-not-cifs.html">SMB not CIFS</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Group Policy Scripts can fail due to UAC</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2007-04-02T22:57:00+10:00" itemprop="datePublished">Apr 2, 2007
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Aaron Parker</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>If you are starting to deploy Windows Vista you may have noticed that any user who has administrative access to their workstation will not receive mapped drives or printers. This is due to the new privilege model introduced in Windows Vista with <a href="http://technet.microsoft.com/en-us/windowsvista/aa905117.aspx">User Account Control</a>.</p>

<p>Microsoft has a complete explanation of why this behaviour with Group Policy scripts occurs at the TechNet site – <a href="http://technet2.microsoft.com/WindowsVista/en/library/5ae8da2a-878e-48db-a3c1-4be6ac7cf7631033.mspx?mfr=true">Deploying Group Policy Using Windows Vista</a>. Just over half way down the page you’ll find a section titled ‘<strong>Group Policy Scripts can fail due to User Account Control</strong>‘, however here’s a quote from that page that summarises the issue:</p>

<blockquote>
  <p>When the administrative user logs on, Windows processes the logon scripts using the elevated token. The script actually works and maps the drive. However, Windows blocks the view of the mapped network drives because the desktop uses the limited token while the drives were mapped using the elevated token.</p>
</blockquote>

<p>So what do we do to get around this? There are a few different methods:</p>

<ol>
  <li>Don’t add users to the local Administrators group on the workstation</li>
  <li>Detect Windows Vista and create a scheduled task to run a logon script via Task Scheduler</li>
  <li>Disable User Account Control</li>
</ol>

<p>My first recommendation, don’t add users to the local Administrators group, is the best way forward. By not adding users to the local Administrators group, the user will never have an administrative token and the logon script runs at the same elevation level as Windows Explorer. This way you don’t need to make any script changes and you are in the best position for <a href="http://www.microsoft.com/technet/windowsvista/security/defend_against_malware.mspx">protecting your machines against malware</a>.</p>

<p>If this method is not for you, then you will have to follow the instructions listed in the <a href="http://technet2.microsoft.com/WindowsVista/en/library/5ae8da2a-878e-48db-a3c1-4be6ac7cf7631033.mspx?mfr=true">Deploying Group Policy Using Windows Vista</a> article and run a logon script using the task scheduler. To do this you will have to detect the presence of Windows Vista and then use <a href="http://www.stealthpuppy.com/blogs/travelling/pages/launchapp-wsf.aspx">LaunchApp.WSF</a> to create a scheduled task to run the actual logon script.</p>

<p>I think the easiest way is to use a <a href="http://technet2.microsoft.com/WindowsServer/en/library/6237b9b2-4a21-425e-8976-2065d28b31471033.mspx">WMI Filter</a> to ensure a Group Policy runs only on Windows Vista. This will require two separate Group Policy objects – one GPO used for Windows Server 2003 and below and another for Windows Vista and above. The WMI Filters would then look like this:</p>

<p>Windows Server 2003 and below:</p>

<p>[code]Select * from Win32_OperatingSystem where BuildNumber &lt; “6000”[/code]</p>

<p>Windows Vista and above:</p>

<p>[code]Select * from Win32_OperatingSystem where BuildNumber &gt;= “6000”[/code]</p>

<p>Another method would be to detect the operating system version as a part of a script and then launch specific logon scripts depending on what operating system is detected. Here’s a VBscript that will do this for you:</p>

<p>[code]Dim wshShell<br />
Set wshShell = CreateObject(“WScript.Shell”)<br />
If IsVista Then<br />
runVistaStyle<br />
Else<br />
runNormalStyle<br />
End If</p>

<p>Sub runVistaStyle()<br />
wshShell.Run(“cscript [path_to_launchapp.wsf] [path_to_userlogin_script]”)<br />
End Sub</p>

<p>Sub runNormalStyle()<br />
wshShell.Run(“[path_to_userlogin_script]”)<br />
End Sub</p>

<p>Function IsVista()<br />
strComputer = “.”<br />
Set objWMIService = GetObject(“winmgmts:” &amp; “{impersonationLevel=impersonate}!\” &amp; strComputer &amp; “\root\cimv2”)<br />
Set colOSes = objWMIService.ExecQuery(“Select * from Win32_OperatingSystem”)<br />
For Each objOS in colOSes<br />
BuildNumber = objOS.BuildNumber<br />
Next<br />
If BuildNumber &gt;= 6000 Then<br />
IsVista = True<br />
Else<br />
IsVista = False<br />
End If<br />
End Function[/code]</p>

<p>Lastly you have the option to <a href="http://www.google.com/search?q=disable+User+Account+Control+&amp;rls=com.microsoft:en-AU&amp;ie=UTF-8&amp;oe=UTF-8&amp;startIndex=&amp;startPage=1">disable User Account Control</a> completely; however <strong>I do not recommend this at all</strong> and as it’s a topic all of it’s own, I’m not going into the how or why of this option here.</p>

<p><strong>UPDATE</strong>: <a href="http://windowsconnected.com/blogs/joshs_blog/archive/2007/02/20/windows-vista-tip-enabledlinkedconnections.aspx">Josh points out</a> you can add the following key to the registry as a work around, however it is not supported by Microsoft:</p>

<p>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System<br />
EnableLinkedConnections = 1 (DWord)</p>

<p>I still recommend your best option is not to make users administrators of their machines.</p>

  </div><a class="u-url" href="/group-policy-scripts-can-fail-due-to-uac/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">stealthpuppy</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">stealthpuppy</li><li><a class="u-email" href="mailto:aaron@stealthpuppy.com">aaron@stealthpuppy.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/aaronparker"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">aaronparker</span></a></li><li><a href="https://www.twitter.com/stealthpuppy"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">stealthpuppy</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>on end user computing and enterprise mobility
</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
