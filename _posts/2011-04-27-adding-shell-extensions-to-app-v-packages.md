---
id: 2246
title: Adding Shell Extensions to App-V Packages
date: 2011-04-27T20:28:07+10:00
author: Aaron Parker
layout: post
guid: http://blog.stealthpuppy.com/?p=2246
permalink: /adding-shell-extensions-to-app-v-packages/
has_been_twittered:
  - 'yes'
dsq_thread_id:
  - "289943077"
categories:
  - Applications
tags:
  - App-V
---
Inspired by a post on the ThinApp blog on [Adding Shell Extensions to ThinApp Packages](http://blogs.vmware.com/thinapp/2011/04/adding-shell-extensions-to-thinapp-packages.html), I've documented here how to add Shell Extensions to an App-V package using the Windows Installer file generated by the App-V Sequencer.

### Caveats

There are several caveats to keep in mind:

  * By default, App-V only adds file type associations so that you can double click on a file to open it in a virtual package. This approach is not changing that behaviour
  * This will only work for file or folder right-click menu options, it won't get other shell integration working
  * As we are editing the package Windows Installer file, your App-V deployment must use the MSI file to install the package. You could use an OSD script to integrate these changes, but the user would need to run the package at least once for the script to execute

### Right-click Items for WinRAR

In this example, I'm using [WinRAR](http://www.rarlab.com/download.htm) (just like the ThinApp example), so I've had to determine the command line passed to WinRAR by each right-click item. To do that I've used [Process Explorer](http://technet.microsoft.com/en-us/sysinternals/bb896653) with an installed version of WinRAR.

In this example, I will add the following right-click options:

  * _Add to archive..._ to folders
  * _Compress and email..._ to folders
  * _Extract files..._ to .RAR files

Viewing the properties of the WINRAR.EXE process displays the command line used for each item:

<img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="WinRAR-CommandLine" border="0" alt="WinRAR-CommandLine" src="{{site.baseurl}}/media/2011/04/WinRAR-CommandLine.png" width="447" height="326" /> 

### Editing the MSI

To add these right-click items, I'm using my favourite MSI editor [InstEd](http://www.instedit.com/) to open the MSI that the App-V Sequencer generated when I sequenced WinRAR. Making these edits was a manual process for me, but depending on which MSI editor you use there are probably simpler ways of achieving the same thing.

There are four tables in the MSI where I need to make changes:

  * Component
  * Registry
  * FeatureComponents
  * InstallExecuteSequence

### Component Table

Go to the Component table and create a new entry. This will require a unique name (Iâ€™ve used _AppVShellValues_) and GUID - your MSI editor should be able to generate the GUID for you.

[<img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="Component-Table" border="0" alt="Component-Table" src="{{site.baseurl}}/media/2011/04/Component-Table_thumb.png]({{site.baseurl}}/media/2011/04/Component-Table.png)

### Registry Table

The Registry table, which is empty by default, will require one entry per addition to the Registry. In this example I have three entries:

[table id=28 /]

The entries will each need to use the following items:

  * _Registry_: this requires a unique value
  * _Root_: the value corresponds to HKLM
  * _Key_: the key path will be dependent on the menu item; however each key will require the \Command path
  * _Name_: this is the Registry value being added, in this example we are editing the default value, so leave this as null
  * _Value_: the command that the item will run. This passes command line arguments to SFTTRAY which will launch the application and then pass the command line to WinRAR. 
  * _Component__: use the component name created in the previous step

The command stored in the Value column must launch the application via the App-V Client and pass parameters to that application:

  * I can reference the App-V Client install folder as [SGINSTALLPATH] as this is a property in the MSI
  * I need to use the application name as listed in the App-V shortcut. In my example I can use [ProductName] because the App-V package name and the application name are the same; however this may not be the case for all packages. The application name may need to be hard coded into the MSI here. You could create a new entry in the Property table for the application name and reference it here
  * The rest of the command is what is passed to the application by SFTTRAY.EXE

[<img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="Registry-Table" border="0" alt="Registry-Table" src="{{site.baseurl}}/media/2011/04/Registry-Table_thumb.png]({{site.baseurl}}/media/2011/04/Registry-Table.png)

### FeatureComponents Table

Add a new entry to the FeatureComponents table - use _VirtualApp_ in the Feature_ column and select the same component used in the previous tables in the Component_ column

[<img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="FeatureComponents-Table" border="0" alt="FeatureComponents-Table" src="{{site.baseurl}}/media/2011/04/FeatureComponents-Table_thumb.png]({{site.baseurl}}/media/2011/04/FeatureComponents-Table.png)

### InstallExecuteSequence Table

The last step is to ensure that the Registry entries added to the MSI are installed in the correct order. As the MSI file is really just a wrapper for the SFTMIME command, the Registry entries could be overwritten when the SFTMIME command adds the package.

To change the sequence find the _WriteRegistryValues_ entry which will have a Sequence value of _5000_. Change this value to _6580_ which will ensure that our custom Registry entries are added after the package is added and loaded but before the installer completes its finalize tasks.

[<img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="InstallExecuteSequence-Table" border="0" alt="InstallExecuteSequence-Table" src="{{site.baseurl}}/media/2011/04/InstallExecuteSequence-Table_thumb.png]({{site.baseurl}}/media/2011/04/InstallExecuteSequence-Table.png)

### Install the Package

If the modifications to the MSI have been completed correctly, you should see your right-click menu options from within Windows Explorer:

<img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="RightClickMenu" border="0" alt="RightClickMenu" src="{{site.baseurl}}/media/2011/04/RightClickMenu.png" width="207" height="367" />